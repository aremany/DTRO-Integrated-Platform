<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <!-- jsPDF & html2canvas CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3í˜¸ì„  ì „ë ¥ê´€ì œ ì¥ì•  ê´€ë¦¬ í†µí•© í”Œë«í¼</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <style>
        body {
            font-family: 'Arial', sans-serif;
            background-color: #f8f9fa;
        }

        .navbar {
            background-color: #8494a4 !important;
        }

        .navbar-brand {
            color: #ffffff !important;
            font-weight: bold;
            display: flex;
            align-items: center;
            text-decoration: none;
            transition: opacity 0.3s ease;
            font-size: 1.75rem;
            /* ê¸€ì í¬ê¸° ì¡°ì • */
        }

        .navbar-brand:hover {
            color: #ffffff !important;
            text-decoration: none;
            opacity: 0.8;
        }

        .navbar-brand img {
            height: 40px;
            width: auto;
            margin-right: 15px;
            border-radius: 4px;
        }

        .container-fluid {
            padding-top: 20px;
        }

        .card {
            margin-bottom: 20px;
            border: none;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .card-header {
            background-color: #e9ecef;
            border-bottom: 1px solid #dee2e6;
            font-weight: bold;
        }

        .table-responsive {
            margin-top: 20px;
        }

        .table th,
        .table td {
            vertical-align: middle;
        }

        .badge-risk-high {
            background-color: #dc3545;
            color: white;
        }

        .badge-risk-medium {
            background-color: #ffc107;
            color: #343a40;
        }

        .badge-risk-low {
            background-color: #28a745;
            color: white;
        }

        @keyframes blink {

            0%,
            50% {
                opacity: 1;
            }

            51%,
            100% {
                opacity: 0.3;
            }
        }

        .loading-dots {
            animation: blink 1.5s infinite;
        }

        .loading-full {
            animation: blink 1.5s infinite;
            text-align: center !important;
        }

        .floating-chat-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            z-index: 1000;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background-color: #007bff;
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 24px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .floating-chat-btn:hover {
            background-color: #0056b3;
        }

        .chat-window {
            position: fixed;
            bottom: 100px;
            right: 30px;
            width: 350px;
            height: 450px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            z-index: 999;
            display: none;
            flex-direction: column;
        }

        .chat-header {
            background-color: #007bff;
            color: white;
            padding: 10px;
            border-top-left-radius: 8px;
            border-top-right-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-body {
            flex-grow: 1;
            padding: 10px;
            overflow-y: auto;
            background-color: #e9ecef;
        }

        .chat-input-area {
            display: flex;
            padding: 10px;
            border-top: 1px solid #dee2e6;
        }

        .chat-input-area input {
            flex-grow: 1;
            border-radius: 20px;
            padding: 8px 15px;
            border: 1px solid #ced4da;
        }

        .chat-input-area button {
            margin-left: 10px;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: #007bff;
            color: white;
            border: none;
        }

        .message-bubble {
            padding: 8px 12px;
            border-radius: 15px;
            margin-bottom: 8px;
            max-width: 80%;
            word-wrap: break-word;
        }

        .message-user {
            background-color: #dcf8c6;
            align-self: flex-end;
            margin-left: auto;
        }

        .message-ai {
            background-color: #ffffff;
            align-self: flex-start;
            margin-right: auto;
        }

        /* Modal Styles */
        .modal-dialog {
            max-width: 90%;
        }

        .modal-body {
            min-height: 400px;
        }

        .nav-tabs .nav-link.active {
            background-color: #007bff;
            color: white;
        }

        .nav-tabs .nav-link {
            color: #007bff;
        }

        @media print {
            body {
                font-family: Arial, sans-serif;
                line-height: 1.6;
            }

            img {
                max-width: 100%;
                height: auto;
            }

            .chart-container {
                text-align: center;
                margin: 20px 0;
            }
        }
    </style>
</head>

<body>
    <nav class="navbar navbar-expand-lg navbar-dark">
        <a class="navbar-brand" href="/" onclick="location.reload(); return false;">
            <img src="io.png" alt="Company Logo">
            3í˜¸ì„  ì „ë ¥ê´€ì œ ì¥ì•  ê´€ë¦¬ í†µí•© í”Œë«í¼
        </a>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav ml-auto">
                <li class="nav-item ml-2">
                    <button class="btn my-2 my-sm-0" id="navChatbotBtn"
                        style="font-weight: bold; font-size: 1.25rem; background-color: #6f42c1; border-color: #6f42c1; color: white;">ì‚¬ê·œì±—ë´‡</button>
                </li>
                <li class="nav-item d-flex align-items-center ml-2">
                    <select id="predictionYearSelect" class="form-control mr-2" style="width: auto; font-size: 1rem;">
                        <!-- Options will be populated dynamically -->
                    </select>
                    <button class="btn btn-info my-2 my-sm-0" id="overallPredictionBtn"
                        style="font-weight: bold; font-size: 1.25rem;">ì¢…í•© ì˜ˆì¸¡ ëŒ€ì‹œë³´ë“œ</button>
                </li>
                <li class="nav-item ml-2">
                    <button class="btn btn-warning my-2 my-sm-0" id="trainingModeBtn"
                        style="font-weight: bold; font-size: 1.25rem;">ì¥ì• ëŒ€ì‘ í›ˆë ¨ëª¨ë“œ ì‹¤í–‰</button>
                </li>
            </ul>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        ì¥ì•  ë³´ê³ ì„œ í•„í„°(ì¥ì• ëª… ì„ íƒì‹œ AIë¶„ì„ ë° ì˜ˆì¸¡ì´ ì‹¤í–‰ë©ë‹ˆë‹¤. ì „ì²´ ì¥ì•  ì˜ˆì¸¡ì€ "ì¢…í•© ì˜ˆì¸¡ ëŒ€ì‹œë³´ë“œ"ë¥¼ í™œìš©í•˜ì„¸ìš”.)
                    </div>
                    <div class="card-body">
                        <form class="form-inline">

                            <div class="form-group mx-sm-3 mb-2">
                                <label for="faultTypeSelect" class="sr-only">ì¥ì•  ìœ í˜•</label>
                                <select class="form-control" id="faultTypeSelect">
                                    <option value="">ëª¨ë“  ì¥ì•  ìœ í˜•</option>
                                    <!-- Options will be loaded dynamically -->
                                </select>
                            </div>
                            <!-- training button moved to navbar (after overallPredictionBtn) -->
                        </form>
                        <div class="card mt-3" id="aiBriefingCard" style="display:none;">
                            <div class="card-header">
                                <i class="fas fa-robot"></i> AI ë¶„ì„ ë¸Œë¦¬í•‘
                            </div>
                            <div class="card-body">
                                <!-- í†µê³„ ìš”ì•½ ë°•ìŠ¤ -->
                                <div class="row mb-3" id="briefingStats" style="display:none;">
                                    <div class="col-md-3">
                                        <div class="text-center p-2 rounded"
                                            style="background-color: #007bff; color: white;">
                                            <small class="text-white" style="font-size:2rem;">ì´ ë°œìƒê±´ìˆ˜</small>
                                            <h4 class="text-white mb-0" id="totalIncidents" style="font-size:2rem;">0
                                            </h4>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="text-center p-2 rounded"
                                            style="background-color: #ffc107; color: #212529;">
                                            <small style="color: #212529; font-size:2rem;">ì¤‘ìš”ë„</small>
                                            <h4 class="mb-0" id="importanceLevel"
                                                style="color: #212529; font-size:2rem;">-</h4>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="text-center p-2 rounded"
                                            style="background-color: #b3d9ff; color: #212529;">
                                            <small style="color: #212529; font-size:2rem;">ì£¼ìš” ì›ì¸</small>
                                            <h4 class="mb-0" id="causesCount" style="color: #212529; font-size:2rem;">0
                                            </h4>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="text-center p-2 rounded"
                                            style="background-color: #fd7e14; color: white;">
                                            <small class="text-white" style="font-size:2rem;">ì¡°ì¹˜ë°©ë²•</small>
                                            <h4 class="text-white mb-0" id="actionsCount" style="font-size:2rem;">0</h4>
                                        </div>
                                    </div>
                                </div>

                                <!-- ë¸Œë¦¬í•‘ ë‚´ìš© -->
                                <div id="aiSummaryText" class="briefing-content"
                                    style="white-space: pre-line; font-size:3rem; font-weight: bold; color: #007bff; text-align: left; padding: 30px; background-color: #f8f9fa; border: 3px solid #007bff; border-radius: 15px;">
                                </div>

                                <!-- ë³´ê³ ì„œ ìƒì„± ë²„íŠ¼ (AI ë‹µë³€ì´ ìˆì„ ë•Œë§Œ í‘œì‹œ) -->

                                <!-- ì˜ˆì¸¡ ì°¨íŠ¸ (ì‹¤ì œ API ë°ì´í„° ì—°ê²°, ë†’ì´ ì¦ê°€) -->
                                <div class="mt-4">
                                    <h6 class="mb-2"><i class="fas fa-chart-line"></i> ì›”ë³„ ì¥ì•  ì˜ˆì¸¡</h6>
                                    <div id="aiPredictionChart"
                                        style="height: 300px; border: 1px solid #dee2e6; border-radius: 5px;"></div>
                                    <!-- ë³´ê³ ì„œ ìƒì„± ë²„íŠ¼ (AI ë‹µë³€ì´ ìˆì„ ë•Œë§Œ í‘œì‹œ, ì°¨íŠ¸ ì•„ë˜ë¡œ ì´ë™) -->
                                    <div id="reportButtonContainer" style="display:none;" class="mt-4 text-center">
                                        <button id="generateReportBtn" class="btn btn-primary"
                                            style="font-size:1.4rem; padding: 0.75rem 2.5rem;">
                                            <i class="fas fa-file-alt"></i> AI ë¶„ì„ ë³´ê³ ì„œ ìƒì„±
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        ì¥ì•  ë³´ê³ ì„œ ëª©ë¡
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th style="width: 5%;">ID</th>
                                        <th style="width: 20%;">ì¥ì• ëª…</th>
                                        <th style="width: 15%;">ì¥ì• ì¼ì‹œ</th>
                                        <th style="width: 15%;">ì¥ì†Œ</th>
                                        <th style="width: 25%;">ì›ì¸</th>
                                        <th style="width: 10%;">ì¤‘ìš”ë„</th>
                                        <th style="width: 10%;">ë‚´ìš©</th>
                                    </tr>
                                </thead>
                                <tbody id="faultsTableBody">
                                    <!-- Fault data will be loaded dynamically -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- AI ë³´ê³ ì„œ ìƒì„± ëª¨ë‹¬ -->

    <!-- Training Mode Floating Modal -->
    <div id="trainingModal" class="training-modal">
        <div class="training-modal-backdrop" onclick="closeTrainingModal()"></div>
        <div class="training-modal-panel">
            <div class="training-modal-header">
                <h5>í›ˆë ¨ ëª¨ë“œ ì„ íƒ</h5>
                <button class="btn-close" onclick="closeTrainingModal()">Ã—</button>
            </div>
            <div class="training-modal-body">
                <p class="muted">ì‹œë®¬ë ˆì´í„°ë¥¼ ì‹¤í–‰í•˜ì—¬ ì˜ˆì¸¡ëœ ì¥ì•  ëŒ€ì‘ í›ˆë ¨ì„ ì‹¤ì‹œí•©ë‹ˆë‹¤.</p>
                <div class="alert alert-warning w-100 text-center" role="alert">
                    <strong><i class="fas fa-exclamation-triangle"></i> ë³´ì•ˆ ì•ˆë‚´ ë° í™œìš© íŒ</strong><br>
                    ì‹¤ì œ ì „ë ¥ ê³„í†µ ì‹œë®¬ë ˆì´í„°(12/22ê³„í†µ, ë³¸ì„ )ëŠ” êµ­ê°€ ì¤‘ìš” ì‹œì„¤ ë³´ì•ˆ ê·œì •ì— ë”°ë¼ í¬í•¨ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.<br>
                    <hr>
                    <small class="d-block text-left pl-3">
                        <strong>ğŸ’¡ í™œìš© ë°©ë²•:</strong><br>
                        1. ì´ ë²„íŠ¼ë“¤ì„ <strong>CCTV ë³´ê¸°, ì™¸ë¶€ ë§í¬, ëŒ€ì‹œë³´ë“œ</strong> ë“± ë‹¤ë¥¸ ê¸°ëŠ¥ìœ¼ë¡œ ìˆ˜ì •í•˜ì—¬ ì‚¬ìš©í•˜ì„¸ìš”.<br>
                        2. ë˜ëŠ” ì§ì ‘ ì œì‘í•œ ì‹œë®¬ë ˆì´í„°(SVG/JS)ë¥¼ í´ë”ì— ë„£ê³  ì—°ë™í•˜ì—¬ ì‚¬ìš©í•˜ì„¸ìš”.<br>
                        (êµ¬í˜„ ì˜ˆì‹œëŠ” <code>DTRO-Power-Simulator</code> ë¦¬í¬ì§€í† ë¦¬ ì°¸ì¡°)
                    </small>
                </div>
                <!--
                    <button class="sim-btn sim-12" onclick="launchSimulator('12')"><i class="fas fa-bolt"></i><span>AC
                            1/2ê³„í†µ<br><small>ì‹œë®¬ë ˆì´í„°</small></span></button>
                    <button class="sim-btn sim-22" onclick="launchSimulator('22')"><i class="fas fa-bolt"></i><span>AC
                            2/2ê³„í†µ<br><small>ì‹œë®¬ë ˆì´í„°</small></span></button>
                    <button class="sim-btn sim-dc" onclick="launchSimulator('dc')"><i class="fas fa-train"></i><span>ë³¸ì„ 
                            ì „ì°¨ì„ <br><small>ì‹œë®¬ë ˆì´í„°</small></span></button>
                    -->
                <!-- training-note removed as requested -->
            </div>
        </div>
    </div>

    <style>
        /* Training modal styles */
        .training-modal {
            position: fixed;
            inset: 0;
            display: none;
            z-index: 2000;
        }

        .training-modal.open {
            display: block;
        }

        .training-modal-backdrop {
            position: absolute;
            inset: 0;
            background: rgba(0, 0, 0, 0.45);
            backdrop-filter: blur(2px);
        }

        .training-modal-panel {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 760px;
            max-width: calc(100% - 120px);
            background: linear-gradient(180deg, #ffffff, #f7fbff);
            border-radius: 16px;
            box-shadow: 0 20px 64px rgba(0, 0, 0, 0.36);
            overflow: hidden;
            transform: translate(-50%, -48%) scale(0.98);
            animation: modalIn .18s cubic-bezier(.2, .8, .2, 1) forwards;
            padding: 0;
        }

        @keyframes modalIn {
            from {
                opacity: 0;
                transform: translate(-50%, -36%) scale(0.96);
            }

            to {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1);
            }
        }

        .training-modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 24px 26px;
            border-bottom: 1px solid #eef3ff;
        }

        .training-modal-header h5 {
            margin: 0;
            color: #0b5ed7;
            font-size: 2.0rem;
        }

        .training-modal-header .btn-close {
            background: none;
            border: none;
            font-size: 28px;
            line-height: 1;
            cursor: pointer;
        }

        .training-modal-body {
            padding: 26px;
        }

        .training-modal-body .muted {
            color: #6c757d;
            margin-bottom: 16px;
            font-size: 1.25rem;
        }

        .sim-buttons {
            display: flex;
            gap: 16px;
            flex-wrap: nowrap;
            align-items: stretch;
        }

        .sim-btn {
            flex: 1 1 180px;
            padding: 22px 20px;
            border-radius: 12px;
            border: none;
            cursor: pointer;
            font-weight: 900;
            color: #fff;
            box-shadow: 0 10px 28px rgba(11, 94, 215, 0.14);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 10px;
            min-height: 130px;
        }

        .sim-btn i {
            font-size: 36px;
        }

        .sim-btn span {
            display: inline-block;
            text-align: center;
            line-height: 1.05;
            font-size: 1.3rem;
        }

        .sim-btn small {
            opacity: 0.95;
            font-weight: 800;
            font-size: 1rem;
        }

        .sim-12 {
            background: linear-gradient(90deg, #4b7bec, #3867d6);
        }

        .sim-22 {
            background: linear-gradient(90deg, #20bf6b, #0fbf5b);
        }

        .sim-dc {
            background: linear-gradient(90deg, #fd7e14, #ff6b6b);
        }

        .training-note {
            margin-top: 12px;
            color: #8891a5;
            font-size: 13px;
        }

        @media (max-width:760px) {
            .training-modal-panel {
                position: fixed;
                left: 12px;
                right: 12px;
                top: 10%;
                transform: none;
                width: auto;
            }

            .training-modal-header h5 {
                font-size: 1.25rem;
            }

            .sim-btn {
                min-height: 100px;
                padding: 14px;
            }

            .sim-btn i {
                font-size: 24px;
            }

            .sim-btn span {
                font-size: 1rem;
            }
        }
    </style>
    <div class="modal fade" id="aiReportModal" tabindex="-1" aria-labelledby="aiReportModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="aiReportModalLabel">
                        <i class="fas fa-robot"></i> AI ì¥ì•  ë¶„ì„ ë³´ê³ ì„œ
                    </h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <!-- ë³´ê³ ì„œ ë©”íƒ€ ì •ë³´ -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="card"
                                style="background: linear-gradient(90deg, #e3f2fd 70%, #bbdefb 100%); box-shadow: 0 2px 8px rgba(0,0,0,0.07);">
                                <div class="card-body" style="font-size:1.5rem;">
                                    <h6 class="card-title" style="font-size:1.7rem;">ë³´ê³ ì„œ ì •ë³´</h6>
                                    <p class="mb-1"><strong>ì¥ì• ëª…:</strong> <span id="reportFaultType">-</span></p>
                                    <p class="mb-1"><strong>ìƒì„±ì¼ì‹œ:</strong> <span id="reportDateTime">-</span></p>
                                    <p class="mb-0"><strong>ë¶„ì„ëª¨ë“œ:</strong> <span id="reportMode">-</span></p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card"
                                style="background: linear-gradient(90deg, #fff3e0 70%, #ffe0b2 100%); box-shadow: 0 2px 8px rgba(0,0,0,0.07);">
                                <div class="card-body" style="font-size:1.5rem;">
                                    <h6 class="card-title" style="font-size:1.7rem;">í†µê³„ ìš”ì•½</h6>
                                    <p class="mb-1"><strong>ì´ ë°œìƒê±´ìˆ˜:</strong> <span id="reportTotalIncidents">-</span>ê±´
                                    </p>
                                    <p class="mb-1"><strong>ì—°í‰ê·  ë¹ˆë„:</strong> <span id="reportYearlyFreq">-</span>ê±´</p>
                                    <p class="mb-0"><strong>ì¤‘ìš”ë„:</strong> <span id="reportImportance">-</span></p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- AI ë¶„ì„ ë‚´ìš© -->
                    <div class="card">
                        <div class="card-header">
                            <h6 class="mb-0"><i class="fas fa-brain"></i> AI ë¶„ì„ ë‚´ìš©</h6>
                        </div>
                        <div class="card-body">
                            <div id="reportAiContent"
                                style="white-space: pre-line; font-family: 'Noto Sans KR', sans-serif; line-height: 1.6; font-size:1.3rem;">
                                <!-- AI ë¶„ì„ ë‚´ìš©ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                            </div>
                        </div>
                    </div>

                    <!-- ì˜ˆì¸¡ ì°¨íŠ¸ -->
                    <div class="card mt-3">
                        <div class="card-header">
                            <h6 class="mb-0"><i class="fas fa-chart-line"></i> ì›”ë³„ ì¥ì•  ì˜ˆì¸¡</h6>
                        </div>
                        <div class="card-body">
                            <div id="reportChartContainer" style="text-align: center; min-height: 200px;">
                                <div id="modalPredictionChart" style="width: 100%; height: 450px;"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-success" id="downloadPdfBtn">
                            <i class="fas fa-file-pdf"></i> PDF ë‹¤ìš´ë¡œë“œ
                        </button>
                        <button type="button" class="btn btn-info" id="downloadWordBtn">
                            <i class="fas fa-file-code"></i> HTML ìƒì„±
                        </button>
                        <button type="button" class="btn btn-warning" id="printReportBtn">
                            <i class="fas fa-print"></i> ì¸ì‡„
                        </button>
                        <button type="button" class="btn btn-outline-primary" id="copyReportBtn">
                            <i class="fas fa-copy"></i> í´ë¦½ë³´ë“œ ë³µì‚¬
                        </button>
                    </div>
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">ë‹«ê¸°</button>
                </div>
            </div>
        </div>
    </div>



    <!-- Detailed Analysis Modal -->
    <div class="modal fade" id="detailedAnalysisModal" tabindex="-1" aria-labelledby="detailedAnalysisModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="detailedAnalysisModalLabel">ìƒì„¸ ë‚´ìš©</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body" style="position: relative;">
                    <div id="modalLoadingOverlay"
                        style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255, 255, 255, 0.8); display: flex; justify-content: center; align-items: center; z-index: 1000; flex-direction: column;">
                        <div class="spinner-border text-primary" role="status">
                            <span class="sr-only">Loading...</span>
                        </div>
                        <p class="mt-2" id="modalLoadingText">ìƒì„¸ ë‚´ìš© ë¡œë”© ì¤‘...</p>
                    </div>

                    <!-- ì¥ì•  ê¸°ë³¸ ì •ë³´ -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="card border-primary">
                                <div class="card-header bg-primary text-white">
                                    <h4 class="mb-0" style="font-size:2rem;">ğŸ“‹ ê¸°ë³¸ ì •ë³´</h4>
                                </div>
                                <div class="card-body">
                                    <p style="font-size:1.3rem;"><strong>ì¥ì• ëª…:</strong> <span
                                            id="modalFaultType">-</span></p>
                                    <p style="font-size:1.3rem;"><strong>ë°œìƒì¼ì‹œ:</strong> <span
                                            id="modalFaultDateTime">-</span></p>
                                    <p style="font-size:1.3rem;"><strong>ë°œìƒì¥ì†Œ:</strong> <span
                                            id="modalFaultLocation">-</span></p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card border-warning">
                                <div class="card-header bg-warning text-dark">
                                    <h4 class="mb-0" style="font-size:2rem;">âš ï¸ ì¥ì•  ì •ë³´</h4>
                                </div>
                                <div class="card-body">
                                    <p style="font-size:1.3rem; white-space:pre-line;"><strong>ì¥ì•  ì›ì¸:</strong> <span
                                            id="modalFaultCause">-</span></p>
                                    <p style="font-size:1.3rem; white-space:pre-line;"><strong>ë°œìƒ í˜„ìƒ:</strong> <span
                                            id="modalFaultSymptom">-</span></p>
                                    <p style="font-size:1.3rem; white-space:pre-line;"><strong>ì¡°ì¹˜ ë°©ë²•:</strong> <span
                                            id="modalFaultAction">-</span></p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ì›ë³¸ ì¥ì•  ë³´ê³ ì„œ -->
                    <div class="card border-info">
                        <div class="card-header bg-info text-white">
                            <h4 class="mb-0" style="font-size:2rem;">ğŸ“„ ì›ë³¸ ì¥ì•  ë³´ê³ ì„œ</h4>
                        </div>
                        <div class="card-body">
                            <div id="modalOriginalText"
                                style="background-color: #f8f9fa; padding: 15px; border-radius: 5px; white-space: pre-line; font-family: 'Courier New', monospace; max-height: 400px; overflow-y: auto;">
                                ë‚´ìš©ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
                                <style>
                                    #modalOriginalText {
                                        font-size: 1.6rem;
                                    }
                                </style>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">ë‹«ê¸°</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Overall Prediction Dashboard Modal -->
    <div class="modal fade" id="overallPredictionModal" tabindex="-1" aria-labelledby="overallPredictionModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="overallPredictionModalLabel">ì¢…í•© ì˜ˆì¸¡ ëŒ€ì‹œë³´ë“œ</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <p>ëª¨ë“  ì¥ì•  ìœ í˜•ì— ëŒ€í•œ ë¯¸ë˜ ë°œìƒ ì˜ˆì¸¡ì„ ì œê³µí•©ë‹ˆë‹¤.</p>
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <div id="overallPredictionChart" style="height: 400px; width: 80%;"></div>
                        <div class="ml-3">
                            <button id="downloadCsvBtn" class="btn btn-sm btn-outline-primary">CSV ë‹¤ìš´ë¡œë“œ</button>
                        </div>
                    </div>
                    <div id="overallPredictionTable" class="table-responsive mt-3">
                        <table class="table table-striped table-sm">
                            <thead>
                                <tr>
                                    <th style="min-width:220px;">ì¥ì• ëª…</th>
                                    <th>1ì›”</th>
                                    <th>2ì›”</th>
                                    <th>3ì›”</th>
                                    <th>4ì›”</th>
                                    <th>5ì›”</th>
                                    <th>6ì›”</th>
                                    <th>7ì›”</th>
                                    <th>8ì›”</th>
                                    <th>9ì›”</th>
                                    <th>10ì›”</th>
                                    <th>11ì›”</th>
                                    <th>12ì›”</th>
                                    <th>í•©ê³„</th>
                                    <th>ëª¨ë¸</th>
                                </tr>
                            </thead>
                            <tbody id="overallPredictionTableBody">
                                <!-- Prediction data will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">ë‹«ê¸°</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <script>
        console.log('ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ ì‹œì‘');
        let allFaults = [];
        let filteredFaults = [];
        let faultTypeChart = null; // ECharts instance for AI briefing
        let overallChart = null;   // ECharts instance for overall prediction (ì „ì—­ ê´€ë¦¬)
        let currentAiReportData = null; // AI ë³´ê³ ì„œ ë°ì´í„° ì €ì¥

        // ì§€ì‹ ê²€ìƒ‰ ê´€ë ¨ ì „ì—­ ë³€ìˆ˜
        let currentSearchResults = [];
        let selectedResultIds = new Set();

        // Helper function to debounce input
        function debounce(func, delay) {
            let timeout;
            return function (...args) {
                const context = this;
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(context, args), delay);
            };
        }

        // Function to render faults table
        function renderFaultsTable(faults) {
            const tbody = document.getElementById('faultsTableBody');
            tbody.innerHTML = '';
            faults.forEach(fault => {
                // Prepare tooltip text for detected keywords
                let tooltipText = '';
                if (fault.detected_keywords_json) {
                    try {
                        const detectedKeywords = JSON.parse(fault.detected_keywords_json);
                        if (detectedKeywords.length > 0) {
                            tooltipText = 'ê°ì§€ëœ í‚¤ì›Œë“œ: ' + detectedKeywords.map(k => k.keyword).join(', ');
                        } else {
                            tooltipText = 'ê°ì§€ëœ í‚¤ì›Œë“œ ì—†ìŒ';
                        }
                    } catch (e) {
                        console.error('Error parsing detected_keywords_json:', e);
                        tooltipText = 'í‚¤ì›Œë“œ ì •ë³´ ë¡œë“œ ì˜¤ë¥˜';
                    }
                } else {
                    tooltipText = 'í‚¤ì›Œë“œ ì •ë³´ ì—†ìŒ';
                }

                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${fault.id}</td>
                    <td>${fault.fault_type}</td>
                    <td>${fault.fault_datetime}</td>
                    <td>${fault.location || 'N/A'}</td>
                    <td>${fault.cause || 'N/A'}</td>
                    <td><span class="badge badge-pill badge-risk-${fault.risk_level ? fault.risk_level.toLowerCase() : 'low'}" title="${tooltipText}">${fault.risk_level || 'ë‚®ìŒ'}</span></td>
                    <td>
                        <button class="btn btn-info btn-sm detailed-analysis-btn"
                                data-id="${fault.id}"
                                data-fault-type="${fault.fault_type}"
                                data-raw-text="${fault.raw_text || ''}">ìƒì„¸ ë‚´ìš©</button>
                    </td>
                `;
            });
        }

        // Function to populate filter options
        function populateFilters(faults) {
            const faultTypes = [...new Set(faults.map(f => f.fault_type))].sort();
            const years = [...new Set(faults.map(f => new Date(f.fault_datetime).getFullYear()))].sort((a, b) => b - a);

            const faultTypeSelect = document.getElementById('faultTypeSelect');
            faultTypeSelect.innerHTML = '<option value="">ëª¨ë“  ì¥ì•  ìœ í˜•</option>';
            faultTypes.forEach(type => {
                faultTypeSelect.innerHTML += `<option value="${type}">${type}</option>`;
            });

            // ì¢…í•©ì˜ˆì¸¡ìš© ì—°ë„ ì„ íƒ ì´ˆê¸°í™” (í˜„ì¬ë…„ë„, í˜„ì¬ë…„ë„+1)
            initializePredictionYearSelect();
        }

        // ì¢…í•©ì˜ˆì¸¡ìš© ì—°ë„ ì„ íƒ ì´ˆê¸°í™” í•¨ìˆ˜
        function initializePredictionYearSelect() {
            const currentYear = new Date().getFullYear();
            const nextYear = currentYear + 1;

            const predictionYearSelect = document.getElementById('predictionYearSelect');
            predictionYearSelect.innerHTML = `
                <option value="${currentYear}">${currentYear}ë…„</option>
                <option value="${nextYear}">${nextYear}ë…„</option>
            `;

            // ê¸°ë³¸ê°’ì„ í˜„ì¬ë…„ë„ë¡œ ì„¤ì •
            predictionYearSelect.value = currentYear;
        }

        // Function to apply filters
        function applyFilters() {
            const faultType = document.getElementById('faultTypeSelect').value;

            filteredFaults = allFaults.filter(fault => {
                const matchesFaultType = !faultType || fault.fault_type === faultType;
                return matchesFaultType;
            });
            renderFaultsTable(filteredFaults);
            updateAIBriefing(faultType);
        }

        // Function to update AI Briefing
        const updateAIBriefing = debounce(async (faultType) => {
            const aiBriefingCard = document.getElementById('aiBriefingCard');
            const aiSummaryText = document.getElementById('aiSummaryText');
            const aiPredictionChartDiv = document.getElementById('aiPredictionChart');
            const briefingStats = document.getElementById('briefingStats');
            const reportButtonContainer = document.getElementById('reportButtonContainer');

            if (!faultType) {
                aiBriefingCard.style.display = 'none';
                reportButtonContainer.style.display = 'none';
                currentAiReportData = null;
                return;
            }

            aiBriefingCard.style.display = 'block';
            briefingStats.style.display = 'none'; // ì´ˆê¸°ì—ëŠ” ìˆ¨ê¹€
            aiSummaryText.innerHTML = 'AI ë¶„ì„ì¤‘<span class="loading-dots">...</span>';
            aiSummaryText.classList.add('loading-full');
            // ë¶„ì„ ì‹œì‘ ì‹œ ì›ë˜ ìŠ¤íƒ€ì¼ ìœ ì§€
            aiSummaryText.style.fontSize = '3rem';
            aiSummaryText.style.color = '#007bff';
            aiSummaryText.style.fontWeight = 'bold';
            if (faultTypeChart) {
                faultTypeChart.dispose();
            }
            aiPredictionChartDiv.innerHTML = ''; // Clear previous chart

            try {
                const response = await fetch('/api/briefing', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json; charset=UTF-8' },
                    body: JSON.stringify({ faultType })
                });
                const data = await response.json();

                // ë¸Œë¦¬í•‘ í…ìŠ¤íŠ¸ í‘œì‹œ
                aiSummaryText.textContent = data.ai_summary || 'AI ìš”ì•½ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
                aiSummaryText.classList.remove('loading-full');
                aiSummaryText.style.fontSize = '1.3rem';
                aiSummaryText.style.color = 'black';
                aiSummaryText.style.fontWeight = 'normal';

                // AI ë³´ê³ ì„œ ë°ì´í„° ì €ì¥
                if (data.ai_summary && data.ai_summary.includes('ğŸ¤– **AI ì¶”ì²œ ì¡°ì¹˜ë°©ë²•**:')) {
                    currentAiReportData = {
                        fault_type: faultType || 'ì„ íƒëœ ì¥ì• ',
                        ai_summary: data.ai_summary,
                        statistics: data.statistics,
                        generated_at: new Date().toLocaleString('ko-KR')
                    };
                    reportButtonContainer.style.display = 'block';
                } else {
                    reportButtonContainer.style.display = 'none';
                    currentAiReportData = null;
                }

                // í†µê³„ ì •ë³´ê°€ ìˆìœ¼ë©´ í†µê³„ ë°•ìŠ¤ í‘œì‹œ
                if (data.statistics && data.statistics.total_incidents > 0) {
                    briefingStats.style.display = 'flex';

                    // í†µê³„ ê°’ ì—…ë°ì´íŠ¸
                    document.getElementById('totalIncidents').textContent = data.statistics.total_incidents || 0;

                    const importanceLevelElement = document.getElementById('importanceLevel');
                    importanceLevelElement.textContent = data.statistics.importance_level || '-';

                    // ì¤‘ìš”ë„ì— ë”°ë¥¸ ìƒ‰ìƒ ë³€ê²½
                    importanceLevelElement.className = 'mb-0';
                    if (data.statistics.importance_level === 'ë†’ìŒ') {
                        importanceLevelElement.classList.add('text-danger');
                    } else if (data.statistics.importance_level === 'ì¤‘ê°„') {
                        importanceLevelElement.classList.add('text-dark');
                    } else if (data.statistics.importance_level === 'ë‚®ìŒ') {
                        importanceLevelElement.classList.add('text-success');
                    }

                    document.getElementById('causesCount').textContent = data.statistics.causes_count || 0;
                    document.getElementById('actionsCount').textContent = data.statistics.actions_count || 0;
                }

                // ì˜ˆì¸¡ ì°¨íŠ¸ - ì¢…í•©ì˜ˆì¸¡ ëŒ€ì‹œë³´ë“œì™€ ë™ì¼í•œ API ì‚¬ìš©
                const aiPredictionChartDiv = document.getElementById('aiPredictionChart');
                try {
                    // í˜„ì¬ ì„ íƒëœ ë…„ë„ ê°€ì ¸ì˜¤ê¸°
                    const year = document.getElementById('predictionYearSelect')?.value || new Date().getFullYear();

                    // ì¢…í•©ì˜ˆì¸¡ê³¼ ë™ì¼í•œ ë°©ì‹ìœ¼ë¡œ API í˜¸ì¶œ
                    const queryParams = new URLSearchParams();
                    if (faultType) queryParams.append('fault_type', faultType);

                    if (year) queryParams.append('year', year);

                    const predictionUrl = queryParams.toString() ?
                        `/api/overall_predictions?${queryParams.toString()}` :
                        '/api/overall_predictions';

                    console.log('Fetching prediction data from:', predictionUrl);
                    const predictionResponse = await fetch(predictionUrl);

                    if (predictionResponse.ok) {
                        const predictions = await predictionResponse.json();
                        console.log('Prediction data received:', predictions);

                        if (predictions && predictions.length > 0) {
                            // ì„ íƒëœ ì¥ì•  ìœ í˜•ì— í•´ë‹¹í•˜ëŠ” ì˜ˆì¸¡ë§Œ í•„í„°ë§
                            const targetPrediction = predictions.find(p => p.fault_type === faultType) || predictions[0];

                            console.log('Target Prediction Data:', targetPrediction);
                            if (!targetPrediction || !targetPrediction.monthly || targetPrediction.monthly.length === 0) {
                                console.warn('No valid prediction data found for the selected fault type.');
                            }

                            if (targetPrediction && targetPrediction.monthly && targetPrediction.monthly.length > 0) {
                                // ECharts ì´ˆê¸°í™”
                                if (faultTypeChart) {
                                    faultTypeChart.dispose(); // ê¸°ì¡´ ì°¨íŠ¸ ì œê±°
                                }
                                faultTypeChart = echarts.init(aiPredictionChartDiv);

                                // ì›”ë³„ ë°ì´í„° ì¤€ë¹„ (ì¢…í•©ì˜ˆì¸¡ê³¼ ë™ì¼í•œ ë°©ì‹)
                                const toMM = (s) => (typeof s === 'string' && s.length >= 7 ? s.slice(5) : '');
                                const monthKeys = ['01', '02', '03', '04', '05', '06', '07', '08', '09', '10', '11', '12'];
                                const monthNames = ['1ì›”', '2ì›”', '3ì›”', '4ì›”', '5ì›”', '6ì›”', '7ì›”', '8ì›”', '9ì›”', '10ì›”', '11ì›”', '12ì›”'];
                                const countsMap = new Map((targetPrediction.monthly || []).map(m => [toMM(m.month), m.predicted_count || 0]));
                                const counts = monthKeys.map(mm => countsMap.get(mm) || 0);

                                // ì°¨íŠ¸ ì˜µì…˜ ì„¤ì • (ë§‰ëŒ€ ê·¸ë˜í”„)
                                const option = {
                                    tooltip: {
                                        trigger: 'axis',
                                        formatter: function (params) {
                                            return `${params[0].name}: ${params[0].value}ê±´`;
                                        }
                                    },
                                    xAxis: {
                                        type: 'category',
                                        data: monthNames
                                    },
                                    yAxis: {
                                        type: 'value',
                                        name: 'ì˜ˆìƒ ì¥ì•  ê±´ìˆ˜'
                                    },
                                    series: [{
                                        name: 'ì˜ˆì¸¡ê°’',
                                        data: counts,
                                        type: 'bar',
                                        itemStyle: {
                                            color: '#007bff'
                                        },
                                        barWidth: '60%'
                                    }]
                                };
                                faultTypeChart.setOption(option);

                                // ì°¨íŠ¸ ë Œë”ë§ ì™„ë£Œ í›„ ì´ë¯¸ì§€ ì €ì¥ (í˜¸í™˜ì„± í–¥ìƒ)
                                setTimeout(() => {
                                    if (currentAiReportData && faultTypeChart) {
                                        try {
                                            // ë” ì‘ì€ í¬ê¸°ë¡œ ì´ë¯¸ì§€ ìƒì„± (í˜¸í™˜ì„± ê°œì„ )
                                            const chartImageUrl = faultTypeChart.getDataURL({
                                                type: 'png',
                                                pixelRatio: 1,      // í•´ìƒë„ ë‚®ì¶¤
                                                backgroundColor: '#ffffff',
                                                width: 600,         // í¬ê¸° ì¶•ì†Œ
                                                height: 300         // í¬ê¸° ì¶•ì†Œ
                                            });

                                            // ì´ë¯¸ì§€ ìœ íš¨ì„± ê²€ì¦
                                            if (validateChartImage(chartImageUrl)) {
                                                currentAiReportData.predictionChartImage = chartImageUrl;
                                            } else {
                                                console.error('Generated chart image failed validation');
                                                currentAiReportData.predictionChartImage = null;
                                            }

                                            // ì›”ë³„ ë°ì´í„°ë¥¼ ì˜ˆì¸¡ íŠ¸ë Œë“œ í˜•íƒœë¡œ ë³€í™˜
                                            currentAiReportData.predictionTrendData = monthNames.map((name, index) => ({
                                                month: name,
                                                predicted_count: counts[index]
                                            }));
                                            console.log('Chart image saved successfully', {
                                                imageLength: currentAiReportData.predictionChartImage?.length,
                                                trendDataLength: currentAiReportData.predictionTrendData?.length,
                                                hasImage: !!currentAiReportData.predictionChartImage,
                                                imageStart: currentAiReportData.predictionChartImage?.substring(0, 30),
                                                dimensions: '600x300px'
                                            });
                                        } catch (error) {
                                            console.error('Error saving chart image:', error);
                                            currentAiReportData.predictionChartImage = null;
                                            currentAiReportData.predictionTrendData = null;
                                        }
                                    }
                                }, 1500);  // ì§€ì—° ì‹œê°„ ì¦ê°€
                            } else {
                                // í•´ë‹¹ ì¥ì• ì˜ ì›”ë³„ ë°ì´í„° ì—†ìŒ
                                aiPredictionChartDiv.innerHTML = '<p class="text-muted text-center pt-4">í•´ë‹¹ ì¥ì• ì˜ ì˜ˆì¸¡ ë°ì´í„° ì—†ìŒ</p>';
                                if (currentAiReportData) {
                                    currentAiReportData.predictionChartImage = null;
                                    currentAiReportData.predictionTrendData = null;
                                }
                            }
                        } else {
                            // ì „ì²´ ì˜ˆì¸¡ ë°ì´í„° ì—†ìŒ
                            aiPredictionChartDiv.innerHTML = '<p class="text-muted text-center pt-4">ì˜ˆì¸¡ ë°ì´í„°ë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>';
                            if (currentAiReportData) {
                                currentAiReportData.predictionChartImage = null;
                                currentAiReportData.predictionTrendData = null;
                            }
                        }
                    } else {
                        aiPredictionChartDiv.innerHTML = '<p class="text-warning text-center pt-4">ì˜ˆì¸¡ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨</p>';
                    }
                } catch (predictionError) {
                    console.error('Error fetching prediction data:', predictionError);
                    aiPredictionChartDiv.innerHTML = '<p class="text-danger text-center pt-4">ì˜ˆì¸¡ ì°¨íŠ¸ ë¡œë“œ ì˜¤ë¥˜</p>';
                }

            } catch (error) {
                console.error('Error fetching AI briefing:', error);
                aiSummaryText.textContent = 'AI ë¶„ì„ ë¸Œë¦¬í•‘ ë¡œë“œ ì‹¤íŒ¨.';
                aiPredictionChartDiv.innerHTML = '<p class="text-danger">ì°¨íŠ¸ ë¡œë“œ ì‹¤íŒ¨</p>';
                briefingStats.style.display = 'none';
                reportButtonContainer.style.display = 'none';
                currentAiReportData = null;
            }
        }, 500); // 500ms debounce

        // AI ë³´ê³ ì„œ ìƒì„± ê¸°ëŠ¥
        document.getElementById('generateReportBtn').addEventListener('click', () => {
            if (!currentAiReportData) {
                alert('ë³´ê³ ì„œë¥¼ ìƒì„±í•  AI ë¶„ì„ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            // ì°¨íŠ¸ ì´ë¯¸ì§€ê°€ ì—†ëŠ” ê²½ìš° í˜„ì¬ ë¸Œë¦¬í•‘ ì°¨íŠ¸ì—ì„œ ìƒì„±
            if (!currentAiReportData.predictionChartImage) {
                // faultTypeChartì—ì„œ ì‹œë„
                if (faultTypeChart) {
                    try {
                        currentAiReportData.predictionChartImage = faultTypeChart.getDataURL({
                            type: 'png',
                            pixelRatio: 2,
                            backgroundColor: '#fff',
                            width: 1000,
                            height: 500
                        });
                        console.log('Chart image generated from faultTypeChart');
                    } catch (error) {
                        console.error('Error generating chart image from faultTypeChart:', error);
                    }
                }

                // ì—¬ì „íˆ ì—†ìœ¼ë©´ ì•Œë¦¼
                if (!currentAiReportData.predictionChartImage) {
                    console.warn('No chart image available for report generation');
                }
            }

            // ëª¨ë‹¬ì— ë°ì´í„° ì±„ìš°ê¸°
            document.getElementById('reportFaultType').textContent = currentAiReportData.fault_type;
            document.getElementById('reportDateTime').textContent = currentAiReportData.generated_at;
            document.getElementById('reportMode').textContent = currentAiReportData.statistics?.mode || 'SQL_LLM_Enhanced';
            document.getElementById('reportTotalIncidents').textContent = currentAiReportData.statistics?.total_incidents || 0;
            document.getElementById('reportYearlyFreq').textContent = currentAiReportData.statistics?.yearly_frequency?.toFixed(1) || '0.0';
            document.getElementById('reportImportance').textContent = currentAiReportData.statistics?.importance_level || 'ì •ë³´ì—†ìŒ';
            // ì¤‘ìš”ë„ ìƒ‰ìƒ ë™ì  ì ìš©
            const importanceSpan = document.getElementById('reportImportance');
            const importance = currentAiReportData.statistics?.importance_level || 'ì •ë³´ì—†ìŒ';
            importanceSpan.textContent = importance;
            importanceSpan.className = '';
            if (importance === 'ë†’ìŒ') {
                importanceSpan.classList.add('badge', 'badge-pill', 'badge-risk-high');
            } else if (importance === 'ì¤‘ê°„') {
                importanceSpan.classList.add('badge', 'badge-pill', 'badge-risk-medium');
            } else if (importance === 'ë‚®ìŒ') {
                importanceSpan.classList.add('badge', 'badge-pill', 'badge-risk-low');
            }
            document.getElementById('reportAiContent').textContent = currentAiReportData.ai_summary;

            // ëª¨ë‹¬ì— ì˜ˆì¸¡ ì°¨íŠ¸ í‘œì‹œ
            const modalPredictionChartDiv = document.getElementById('modalPredictionChart');
            if (currentAiReportData.predictionTrendData && currentAiReportData.predictionTrendData.length > 0) {
                // ëª¨ë‹¬ìš© ì°¨íŠ¸ëŠ” ëª¨ë‹¬ì´ ì™„ì „íˆ ì—´ë¦° í›„ì— ì´ˆê¸°í™”
                modalPredictionChartDiv.innerHTML = '<div style="text-align: center; padding: 50px;"><div class="spinner-border" role="status"></div><br><small>ì°¨íŠ¸ ë¡œë”© ì¤‘...</small></div>';

                // ëª¨ë‹¬ì´ ì™„ì „íˆ ì—´ë¦° í›„ ì°¨íŠ¸ ì´ˆê¸°í™”
                setTimeout(() => {
                    const modalChart = echarts.init(modalPredictionChartDiv, null, {
                        width: modalPredictionChartDiv.offsetWidth,
                        height: 450
                    });
                    const option = {
                        tooltip: {
                            trigger: 'axis'
                        },
                        xAxis: {
                            type: 'category',
                            data: currentAiReportData.predictionTrendData.map(item => item.month || item.period)
                        },
                        yAxis: {
                            type: 'value',
                            name: 'ì˜ˆìƒ ì¥ì•  ê±´ìˆ˜'
                        },
                        series: [{
                            name: 'ì˜ˆì¸¡ê°’',
                            data: currentAiReportData.predictionTrendData.map(item => item.predicted_count || item.value),
                            type: 'bar',  // lineì—ì„œ barë¡œ ë³€ê²½í•˜ì—¬ ë” ëª…í™•í•˜ê²Œ í‘œì‹œ
                            itemStyle: {
                                color: '#007bff'
                            },
                            barWidth: '60%'
                        }]
                    };
                    modalChart.setOption(option);
                    // Store the chart instance
                    currentAiReportData.modalChartInstance = modalChart;

                    // ì°¨íŠ¸ í¬ê¸° ì¬ì¡°ì •
                    setTimeout(() => {
                        modalChart.resize();
                    }, 100);
                }, 300);
            } else {
                modalPredictionChartDiv.innerHTML = '<p class="text-muted">ì˜ˆì¸¡ ë°ì´í„° ì—†ìŒ</p>';
                currentAiReportData.modalChartInstance = null; // Clear instance if no chart
            }

            // ëª¨ë‹¬ í‘œì‹œ
            $('#aiReportModal').modal('show');
        });

        // ëª¨ë‹¬ì´ ë‹«í ë•Œ ì°¨íŠ¸ ì¸ìŠ¤í„´ìŠ¤ ì •ë¦¬
        $('#aiReportModal').on('hidden.bs.modal', function () {
            if (currentAiReportData && currentAiReportData.modalChartInstance) {
                currentAiReportData.modalChartInstance.dispose();
                currentAiReportData.modalChartInstance = null;
            }
        });

        // ë³´ê³ ì„œ ë‹¤ìš´ë¡œë“œ ê¸°ëŠ¥ë“¤
        document.getElementById('copyReportBtn').addEventListener('click', () => {
            const reportText = generateReportText();
            navigator.clipboard.writeText(reportText).then(() => {
                alert('ë³´ê³ ì„œê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.');
            }).catch(err => {
                console.error('í´ë¦½ë³´ë“œ ë³µì‚¬ ì‹¤íŒ¨:', err);
                alert('í´ë¦½ë³´ë“œ ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            });
        });

        document.getElementById('printReportBtn').addEventListener('click', () => {
            window.print();
        });

        document.getElementById('downloadPdfBtn').addEventListener('click', () => {
            // PDF ë‹¤ìš´ë¡œë“œ ê¸°ëŠ¥ êµ¬í˜„
            const modalBody = document.querySelector('#aiReportModal .modal-body');
            if (!modalBody) {
                alert('ë³´ê³ ì„œ ë‚´ìš©ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            html2canvas(modalBody, { scale: 3 }).then(canvas => {
                const imgData = canvas.toDataURL('image/png');
                const pdf = new window.jspdf.jsPDF({ orientation: 'p', unit: 'mm', format: 'a4' });
                // PDFì— ì´ë¯¸ì§€ ì‚½ì… (A4 ì „ì²´ í¬ê¸°)
                const pageWidth = pdf.internal.pageSize.getWidth();
                const pageHeight = pdf.internal.pageSize.getHeight();
                pdf.addImage(imgData, 'PNG', 0, 0, pageWidth, pageHeight);
                pdf.save('AI_Report.pdf');
            });
        });

        document.getElementById('downloadWordBtn').addEventListener('click', async () => {
            try {
                // ëª¨ë‹¬ ì°¨íŠ¸ ì¸ìŠ¤í„´ìŠ¤ í™•ì¸
                if (!currentAiReportData.modalChartInstance) {
                    console.error('Modal chart instance is not initialized.');
                    alert('ì°¨íŠ¸ê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ëª¨ë‹¬ì„ ë‹¤ì‹œ ì—´ì–´ì£¼ì„¸ìš”.');
                    return;
                }

                // ì°¨íŠ¸ ì´ë¯¸ì§€ ìº¡ì²˜
                const chartImage = currentAiReportData.modalChartInstance.getDataURL({
                    type: 'png',
                    pixelRatio: 1, // ì´ë¯¸ì§€ í¬ê¸° ìµœì í™”
                });

                if (!chartImage || !chartImage.startsWith('data:image/png;base64,')) {
                    console.error('Failed to capture chart image:', chartImage);
                    alert('ì°¨íŠ¸ ì´ë¯¸ì§€ë¥¼ ìº¡ì²˜í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    return;
                }

                // ë³´ê³ ì„œ í…ìŠ¤íŠ¸ ìƒì„±
                const reportText = generateReportText().replace(/\n/g, '<br>');

                // Word ë¬¸ì„œ ëŒ€ì‹  HTML íŒŒì¼ë¡œ ì €ì¥ (base64 ì´ë¯¸ì§€ ì§ì ‘ ì‚½ì…)
                const htmlBlob = new Blob([`
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>AI ì¥ì•  ë¶„ì„ ë³´ê³ ì„œ</title>
</head>
<body>
    <h1>AI ì¥ì•  ë¶„ì„ ë³´ê³ ì„œ</h1>
    <div>${reportText}</div>
    <div><img src="${chartImage}" style="width: 600px; height: 300px;"/></div>
    <button onclick="window.print()" style="margin-top:20px;">ì¸ì‡„</button>
</body>
</html>
                `], { type: 'text/html' });

                const url = URL.createObjectURL(htmlBlob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'AI_Report.html';
                a.click();
                URL.revokeObjectURL(url);
            } catch (error) {
                console.error('Error generating Word document:', error);
                alert('Word ë¬¸ì„œ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        });

        async function generateChartImage(chartInstance) {
            return new Promise((resolve, reject) => {
                try {
                    const chartImage = chartInstance.getDataURL({
                        type: 'png',
                        pixelRatio: 1, // Reduce resolution
                        backgroundColor: '#ffffff',
                        width: 600, // Reduce size
                        height: 300 // Reduce size
                    });

                    if (validateChartImage(chartImage)) {
                        console.log('Chart image generated successfully:', {
                            size: chartImage.length,
                            preview: chartImage.substring(0, 50)
                        });
                        resolve(chartImage);
                    } else {
                        console.error('Chart image validation failed');
                        reject('Invalid chart image');
                    }
                } catch (error) {
                    console.error('Error generating chart image:', error);
                    reject(error);
                }
            });
        }

        // ì°¨íŠ¸ ì´ë¯¸ì§€ ìœ íš¨ì„± ê²€ì¦ í•¨ìˆ˜
        function validateChartImage(imageDataUrl) {
            if (!imageDataUrl || typeof imageDataUrl !== 'string') {
                return false;
            }

            // Base64 ë°ì´í„° URL í˜•ì‹ í™•ì¸
            if (!imageDataUrl.startsWith('data:image/png;base64,')) {
                return false;
            }

            // ì´ë¯¸ì§€ í¬ê¸° í™•ì¸ (ë„ˆë¬´ í¬ë©´ ë¸Œë¼ìš°ì €ì—ì„œ ë¬¸ì œ ë°œìƒ ê°€ëŠ¥)
            const base64Data = imageDataUrl.split(',')[1];
            if (!base64Data || base64Data.length > 500000) { // 500KB ì œí•œ
                console.warn('Chart image too large:', base64Data?.length);
                return false;
            }

            return true;
        }

        // ë³´ê³ ì„œ í…ìŠ¤íŠ¸ ìƒì„± í•¨ìˆ˜
        function generateReportText() {
            if (!currentAiReportData) return '';

            return `AI ì¥ì•  ë¶„ì„ ë³´ê³ ì„œ

ì¥ì• ëª…: ${currentAiReportData.fault_type}
ìƒì„±ì¼ì‹œ: ${currentAiReportData.generated_at}
ë¶„ì„ëª¨ë“œ: ${currentAiReportData.statistics?.mode || 'SQL_LLM_Enhanced'}

=== í†µê³„ ìš”ì•½ ===
ì´ ë°œìƒê±´ìˆ˜: ${currentAiReportData.statistics?.total_incidents || 0}ê±´
ì—°í‰ê·  ë¹ˆë„: ${currentAiReportData.statistics?.yearly_frequency?.toFixed(1) || '0.0'}ê±´
ì¤‘ìš”ë„: ${currentAiReportData.statistics?.importance_level || 'ì •ë³´ì—†ìŒ'}

=== AI ë¶„ì„ ë‚´ìš© ===
${currentAiReportData.ai_summary}

â€» ë³¸ ë³´ê³ ì„œëŠ” AI ì‹œìŠ¤í…œì— ì˜í•´ ìë™ ìƒì„±ëœ ë¶„ì„ ê²°ê³¼ì…ë‹ˆë‹¤.
`;
        }

        // ë³´ê³ ì„œ HTML ìƒì„± í•¨ìˆ˜ (ì¸ì‡„ìš©)
        function generateReportHtml() {
            const reportText = generateReportText();

            // ì°¨íŠ¸ ì´ë¯¸ì§€ ìƒíƒœ ë””ë²„ê¹…
            console.log('generateReportHtml - Chart image status:', {
                hasCurrentData: !!currentAiReportData,
                hasChartImage: !!currentAiReportData?.predictionChartImage,
                imageLength: currentAiReportData?.predictionChartImage?.length,
                imagePreview: currentAiReportData?.predictionChartImage?.substring(0, 50) + '...'
            });

            // ì°¨íŠ¸ ì´ë¯¸ì§€ HTML ìƒì„±
            let chartImageHtml = '';
            if (currentAiReportData && currentAiReportData.predictionChartImage) {
                console.log('Using chart image in report');
                chartImageHtml = `
                <div style="text-align: center; margin-top: 30px; page-break-inside: avoid;">
                    <h3 style="color: #007bff; margin-bottom: 15px;">ğŸ“Š ì›”ë³„ ì¥ì•  ì˜ˆì¸¡</h3>
                    <img src="${currentAiReportData.predictionChartImage}" style="width: 600px; height: 300px; border: 1px solid #ddd; border-radius: 5px;"/>
                </div>`;
            } else {
                // ì°¨íŠ¸ê°€ ì—†ì„ ë•Œë„ ì•ˆë‚´ ë©”ì‹œì§€ í‘œì‹œ
                chartImageHtml = `
                <div style="text-align: center; margin-top: 30px; page-break-inside: avoid;">
                    <h3 style="color: #007bff; margin-bottom: 15px;">ğŸ“Š ì›”ë³„ ì¥ì•  ì˜ˆì¸¡</h3>
                    <div style="border: 1px solid #ddd; border-radius: 5px; padding: 40px; background-color: #f8f9fa;">
                        <p style="color: #6c757d; margin: 0;">ì˜ˆì¸¡ ì°¨íŠ¸ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
                    </div>
                </div>`;
            }

            return `
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>AI ì¥ì•  ë¶„ì„ ë³´ê³ ì„œ</title>
    <style>
        body { 
            font-family: 'Malgun Gothic', sans-serif; 
            line-height: 1.8; 
            margin: 40px; 
            color: #333;
        }
        .header { 
            text-align: center; 
            margin-bottom: 40px; 
            border-bottom: 2px solid #007bff;
            padding-bottom: 20px;
        }
        .content { 
            white-space: pre-line; 
            font-size: 14px;
        }
        h1 { color: #007bff; margin-bottom: 10px; }
        .timestamp { color: #666; font-size: 12px; }
        @media print {
            .page-break { page-break-before: always; }
            img { max-width: 100%; height: auto; }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ¤– AI ì¥ì•  ë¶„ì„ ë³´ê³ ì„œ</h1>
        <p class="timestamp">ìƒì„±ì¼ì‹œ: ${currentAiReportData ? currentAiReportData.generated_at : new Date().toLocaleString()}</p>
    </div>
    <div class="content">${reportText}</div>
    ${chartImageHtml}
    <div style="margin-top: 40px; padding-top: 20px; border-top: 1px solid #ddd; font-size: 12px; color: #666; text-align: center;">
        â€» ë³¸ ë³´ê³ ì„œëŠ” AI ì‹œìŠ¤í…œì— ì˜í•´ ìë™ ìƒì„±ëœ ë¶„ì„ ê²°ê³¼ì…ë‹ˆë‹¤.
    </div>
</body>
</html>
            `;
        }

        // Initial data fetch
        async function fetchFaults() {
            try {
                const response = await fetch('/api/faults');
                allFaults = await response.json();
                populateFilters(allFaults);
                applyFilters(); // Apply initial filters (empty)
            } catch (error) {
                console.error('Error fetching faults:', error);
                document.getElementById('faultsTableBody').innerHTML = '<tr><td colspan="6" class="text-center text-danger">ì¥ì•  ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</td></tr>';
            }
        }

        // Event Listeners
        document.addEventListener('DOMContentLoaded', () => {
            // If served via file://, browser blocks fetch to http APIs -> skip fetchFaults and warn
            if (location.protocol === 'file:') {
                console.warn('Running from file:// â€” API calls are blocked by browser. Start the server (start_node_only.bat) and open http://localhost:3000 to enable full functionality.');
            } else {
                fetchFaults();
            }

            // Attach training button listener safely (ensure element exists)
            const tBtn = document.getElementById('trainingModeBtn');
            if (tBtn) {
                tBtn.addEventListener('click', () => {
                    document.getElementById('trainingModal').classList.add('open');
                });
            } else {
                console.warn('trainingModeBtn element not found in DOM.');
            }
        });

        // Close handler
        function closeTrainingModal() {
            document.getElementById('trainingModal').classList.remove('open');
        }

        // Prevent clicks inside modal panel from closing it and add explicit close handlers
        const panel = document.querySelector('.training-modal-panel');
        if (panel) {
            panel.addEventListener('click', (e) => {
                e.stopPropagation(); // prevent backdrop from receiving clicks when clicking inside panel
            });
        }

        const backdrop = document.querySelector('.training-modal-backdrop');
        if (backdrop) {
            backdrop.addEventListener('click', closeTrainingModal);
        }

        const closeBtn = document.querySelector('.training-modal-header .btn-close');
        if (closeBtn) {
            closeBtn.addEventListener('click', closeTrainingModal);
        }

        // Launch simulator - opens the simulator folder index in a new tab/window
        function launchSimulator(simKey) {
            // If servers are already running on fixed ports, just open the matching URL.
            const urlMap = {
                '12': 'http://localhost:8111/index.html',
                '22': 'http://localhost:8222/index.html',
                'dc': 'http://localhost:8011/index.html'
            };
            const url = urlMap[simKey];
            if (!url) {
                alert('ì•Œ ìˆ˜ ì—†ëŠ” ì‹œë®¬ë ˆì´í„° í‚¤: ' + simKey);
                return;
            }
            // Open in new tab/window; allow the browser/OS to choose
            window.open(url, '_blank');
            closeTrainingModal();
        }

        document.getElementById('faultTypeSelect').addEventListener('change', applyFilters);

        // Detailed Analysis Modal - ìƒì„¸ ë‚´ìš© í‘œì‹œ
        document.getElementById('faultsTableBody').addEventListener('click', async (event) => {
            if (event.target.classList.contains('detailed-analysis-btn')) {
                const faultId = event.target.dataset.id;
                const faultType = event.target.dataset.faultType;

                const modal = new bootstrap.Modal(document.getElementById('detailedAnalysisModal'));
                modal.show();

                // Show loading overlay
                const modalLoadingOverlay = document.getElementById('modalLoadingOverlay');
                const modalLoadingText = document.getElementById('modalLoadingText');
                modalLoadingOverlay.style.display = 'flex';
                modalLoadingText.textContent = 'ìƒì„¸ ë‚´ìš© ë¡œë”© ì¤‘...';

                // Clear previous content
                document.getElementById('modalFaultType').textContent = '-';
                document.getElementById('modalFaultDateTime').textContent = '-';
                document.getElementById('modalFaultLocation').textContent = '-';
                document.getElementById('modalFaultCause').textContent = '-';
                document.getElementById('modalFaultSymptom').textContent = '-';
                document.getElementById('modalFaultAction').textContent = '-';
                document.getElementById('modalOriginalText').textContent = 'ë‚´ìš©ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...';

                try {
                    // Fetch fault detail
                    const response = await fetch('/api/fault_detail', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ fault_id: faultId })
                    });
                    const data = await response.json();

                    if (response.ok) {
                        // Populate basic information
                        document.getElementById('modalFaultType').textContent = data.fault_type || 'ì •ë³´ì—†ìŒ';
                        document.getElementById('modalFaultDateTime').textContent = data.fault_datetime || 'ì •ë³´ì—†ìŒ';
                        document.getElementById('modalFaultLocation').textContent = data.fault_location || 'ì •ë³´ì—†ìŒ';
                        document.getElementById('modalFaultCause').textContent = data.fault_cause || 'ì •ë³´ì—†ìŒ';
                        document.getElementById('modalFaultSymptom').textContent = data.fault_symptom || 'ì •ë³´ì—†ìŒ';
                        document.getElementById('modalFaultAction').textContent = data.fault_action || 'ì •ë³´ì—†ìŒ';

                        // Format and display original text
                        const originalText = data.original_text || 'ì›ë³¸ í…ìŠ¤íŠ¸ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.';
                        document.getElementById('modalOriginalText').textContent = formatOriginalText(originalText);
                    } else {
                        throw new Error(data.error || 'ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨');
                    }

                } catch (error) {
                    console.error('Error fetching fault detail:', error);
                    document.getElementById('modalOriginalText').textContent = 'ìƒì„¸ ë‚´ìš© ë¡œë“œ ì‹¤íŒ¨: ' + error.message;
                } finally {
                    // Hide loading overlay
                    modalLoadingOverlay.style.display = 'none';
                }
            }
        });

        // Format original text for better readability
        function formatOriginalText(text) {
            if (!text) return 'ì›ë³¸ í…ìŠ¤íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.';

            return text
                .replace(/(\d{4}\.\s*\d{1,2}\.\s*\d{1,2}\.)/g, '\nğŸ“… $1') // ë‚ ì§œ í¬ë§·
                .replace(/(ì¼\s*ì‹œ\s*:|ì‹œ\s*ê°„\s*:|ì¥\s*ì†Œ\s*:|ì›\s*ì¸\s*:|ê°œ\s*ìš”|ê°œ\s*í™©|ì¡°\s*ì¹˜)/g, '\n\nğŸ”¹ $1') // ì„¹ì…˜ í—¤ë”
                .replace(/(\d{2}:\d{2})/g, 'â° $1') // ì‹œê°„ í¬ë§·
                .replace(/(ì™„ë£Œ|ì¡°ì¹˜|ë³µêµ¬|í•´ê²°|ì •ìƒ)/g, 'âœ… $1') // ì™„ë£Œ ìƒíƒœ
                .replace(/(ì¥ì• |ê³ ì¥|ì´ìƒ|ì˜¤ë¥˜|ì‹¤íŒ¨|ë¬¸ì œ)/g, 'âš ï¸ $1') // ë¬¸ì œ ìƒíƒœ
                .replace(/^/, 'ğŸ“„ ') // ì‹œì‘ ë¶€ë¶„ì— ì•„ì´ì½˜ ì¶”ê°€
                .trim();
        }



        // Feedback buttons
        document.getElementById('detailedAnalysisModal').addEventListener('click', async (event) => {
            if (event.target.dataset.feedbackType) {
                const feedbackType = event.target.dataset.feedbackType;
                const faultId = document.querySelector('.detailed-analysis-btn').dataset.id; // Get current fault ID

                try {
                    await fetch('/api/feedback', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ type: feedbackType, fault_id: faultId })
                    });
                    alert('í”¼ë“œë°±ì´ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤. ê°ì‚¬í•©ë‹ˆë‹¤!');
                } catch (error) {
                    console.error('Error sending feedback:', error);
                    alert('í”¼ë“œë°± ì „ì†¡ ì‹¤íŒ¨.');
                }
            }
        });

        // Overall Prediction Dashboard Button
        document.getElementById('overallPredictionBtn').addEventListener('click', async () => {
            const modal = new bootstrap.Modal(document.getElementById('overallPredictionModal'));
            modal.show();

            const overallPredictionChartDiv = document.getElementById('overallPredictionChart');
            const overallPredictionTableBody = document.getElementById('overallPredictionTableBody');

            overallPredictionChartDiv.innerHTML = ''; // Clear previous chart
            overallPredictionTableBody.innerHTML = '<tr><td colspan="3" class="text-center">ì˜ˆì¸¡ ë°ì´í„° ë¡œë”© ì¤‘...</td></tr>';

            try {
                const selectedType = document.getElementById('faultTypeSelect').value || '';
                const selectedYear = document.getElementById('predictionYearSelect').value;

                const q = new URLSearchParams();
                if (selectedType) q.append('fault_type', selectedType);
                if (selectedYear) q.append('year', selectedYear);

                const url = q.toString() ? `http://localhost:3000/api/overall_predictions?${q.toString()}` : 'http://localhost:3000/api/overall_predictions';
                const response = await fetch(url);
                const predictions = await response.json();

                overallPredictionTableBody.innerHTML = ''; // Clear loading message
                if (predictions.length > 0) {
                    // Render matrix: row = fault_type, cols = Jan..Dec + total
                    const toMM = (s) => (typeof s === 'string' && s.length >= 7 ? s.slice(5) : '');
                    const monthKeys = ['01', '02', '03', '04', '05', '06', '07', '08', '09', '10', '11', '12'];
                    predictions.forEach(p => {
                        const countsMap = new Map((p.monthly || []).map(m => [toMM(m.month), m.predicted_count || 0]));
                        const counts = monthKeys.map(mm => countsMap.get(mm) || 0);
                        const total = counts.reduce((a, b) => a + b, 0);
                        const tr = document.createElement('tr');
                        const cells = [`<td title="ì‚¬ìš© ëª¨ë¸: ${p.used_model || 'N/A'}">${p.fault_type}</td>`]
                            .concat(counts.map(c => `<td>${c}</td>`))
                            .concat([`<td><strong>${total}</strong></td>`, `<td>${p.used_model || 'N/A'}</td>`]);
                        tr.innerHTML = cells.join('');
                        overallPredictionTableBody.appendChild(tr);
                    });

                    // ì•ˆì „í•œ ì°¨íŠ¸ ì´ˆê¸°í™” - ì¼ê´€ëœ ì˜ˆì¸¡ê°’ ë³´ì¥
                    if (overallChart) {
                        try {
                            overallChart.dispose(); // ê¸°ì¡´ ì°¨íŠ¸ ì™„ì „íˆ ì œê±°
                        } catch (e) {
                            console.warn('Chart dispose error:', e);
                        }
                        overallChart = null;
                    }

                    // DOM ìƒíƒœ ì´ˆê¸°í™” - ì°¨íŠ¸ ì»¨í…Œì´ë„ˆ ì™„ì „ ì •ë¦¬
                    overallPredictionChartDiv.innerHTML = ''; // ë‚´ë¶€ HTML ì™„ì „ ì •ë¦¬
                    overallPredictionChartDiv.removeAttribute('_echarts_instance_'); // ECharts ì†ì„± ì œê±°
                    overallPredictionChartDiv.style.width = '100%';
                    overallPredictionChartDiv.style.height = '400px';

                    // ê°•ì œ ë¦¬í”Œë¡œìš°ë¡œ DOM ìƒíƒœ í™•ì‹¤íˆ ì—…ë°ì´íŠ¸
                    overallPredictionChartDiv.offsetHeight; // ê°•ì œ ë¦¬í”Œë¡œìš°

                    // ìƒˆë¡œìš´ ì°¨íŠ¸ ì¸ìŠ¤í„´ìŠ¤ ìƒì„±
                    overallChart = echarts.init(overallPredictionChartDiv);

                    // Keep a chart for quick glance: stacked bars per month across fault types
                    const months = ['01', '02', '03', '04', '05', '06', '07', '08', '09', '10', '11', '12'];
                    const series = predictions.map(p => {
                        const m = new Map((p.monthly || []).map(x => [toMM(x.month), x.predicted_count || 0]));
                        const data = months.map(mm => m.get(mm) || 0);
                        return { name: p.fault_type, type: 'bar', stack: 'total', emphasis: { focus: 'series' }, data };
                    });
                    overallChart.setOption({
                        tooltip: {
                            trigger: 'axis',
                            axisPointer: { type: 'shadow' },
                            formatter: function (params) {
                                // 0ê±´ì¸ í•­ëª©ì€ ì œì™¸í•˜ê³  í‘œì‹œ
                                const month = params[0].axisValue;
                                const nonZeroItems = params.filter(item => item.value > 0);

                                if (nonZeroItems.length === 0) {
                                    return `${month}<br/>ì˜ˆì¸¡ëœ ì¥ì•  ì—†ìŒ`;
                                }

                                let result = `${month}<br/>`;
                                nonZeroItems.forEach(item => {
                                    result += `${item.marker} ${item.seriesName}: ${item.value}ê±´<br/>`;
                                });

                                return result;
                            }
                        },
                        legend: { type: 'scroll' },
                        xAxis: { type: 'category', data: months.map(m => `${predictions[0].year}-${m}`) },
                        yAxis: { type: 'value' },
                        series,
                        grid: { left: '3%', right: '4%', bottom: '3%', containLabel: true }
                    });

                    // CSV Download handler with user-defined filename
                    document.getElementById('downloadCsvBtn').onclick = () => {
                        if (!predictions || predictions.length === 0) {
                            alert('ë‹¤ìš´ë¡œë“œí•  ì˜ˆì¸¡ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                            return;
                        }

                        // í˜„ì¬ ë‚ ì§œ/ì‹œê°„ìœ¼ë¡œ ê¸°ë³¸ íŒŒì¼ëª… ìƒì„±
                        const now = new Date();
                        const timestamp = now.getFullYear() +
                            ('0' + (now.getMonth() + 1)).slice(-2) +
                            ('0' + now.getDate()).slice(-2) + '_' +
                            ('0' + now.getHours()).slice(-2) +
                            ('0' + now.getMinutes()).slice(-2);
                        const defaultFilename = `ì˜ˆì¸¡ê²°ê³¼_${timestamp}`;

                        // ì‚¬ìš©ìì—ê²Œ íŒŒì¼ëª… ì…ë ¥ ìš”ì²­
                        const filename = prompt('CSV íŒŒì¼ëª…ì„ ì…ë ¥í•˜ì„¸ìš” (í™•ì¥ì ì œì™¸):', defaultFilename);
                        if (!filename) {
                            alert('íŒŒì¼ëª…ì„ ì…ë ¥í•´ì•¼ ì €ì¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
                            return;
                        }

                        const header = ['ì¥ì• ìœ í˜•', '1ì›”', '2ì›”', '3ì›”', '4ì›”', '5ì›”', '6ì›”', '7ì›”', '8ì›”', '9ì›”', '10ì›”', '11ì›”', '12ì›”', 'ì—°ê°„ì´ê³„', 'ì‚¬ìš©ëª¨ë¸'];
                        const monthKeys = ['01', '02', '03', '04', '05', '06', '07', '08', '09', '10', '11', '12'];
                        const toMM = (s) => (typeof s === 'string' && s.length >= 7 ? s.slice(5) : '');
                        const rows = predictions.map(p => {
                            const map = new Map((p.monthly || []).map(m => [toMM(m.month), m.predicted_count || 0]));
                            const counts = monthKeys.map(mm => map.get(mm) || 0);
                            const total = counts.reduce((a, b) => a + b, 0);
                            return [p.fault_type, ...counts, total, (p.used_model || 'N/A')];
                        });

                        // UTF-8 BOM ì¶”ê°€ë¡œ í•œê¸€ ê¹¨ì§ ë°©ì§€
                        const csv = '\uFEFF' + [header.join(','), ...rows.map(r => r.join(','))].join('\n');
                        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `${filename}.csv`;

                        // ë‹¤ìš´ë¡œë“œ ì‹œì‘ ì „ ì•Œë¦¼
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        URL.revokeObjectURL(url);

                        // ì„±ê³µ ì•Œë¦¼
                        alert(`"${filename}.csv" íŒŒì¼ì´ ë‹¤ìš´ë¡œë“œ í´ë”ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.`);
                    };

                } else {
                    overallPredictionTableBody.innerHTML = '<tr><td colspan="3" class="text-center">ì˜ˆì¸¡ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
                    overallPredictionChartDiv.innerHTML = '<p class="text-muted text-center">ì˜ˆì¸¡ ì°¨íŠ¸ ë°ì´í„° ì—†ìŒ</p>';
                }

            } catch (error) {
                console.error('Error fetching overall predictions:', error);
                overallPredictionTableBody.innerHTML = '<tr><td colspan="3" class="text-center text-danger">ì˜ˆì¸¡ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨.</td></tr>';
                overallPredictionChartDiv.innerHTML = '<p class="danger text-center">ì˜ˆì¸¡ ì°¨íŠ¸ ë¡œë“œ ì‹¤íŒ¨</p>';
            }
        });
    </script>

    <!-- ì§€ì‹ê²€ìƒ‰ í”Œë¡œíŒ… UI -->
    <!-- 1. ê°œì„ ëœ í”Œë¡œíŒ… ë²„íŠ¼ -->
    <div id="knowledgeFloatingBtn" class="knowledge-floating-btn" tabindex="0" role="button" aria-label="ì§€ì‹ê²€ìƒ‰ ì—´ê¸°">
        <div class="btn-icon">ğŸ”</div>
        <div class="btn-text">ì§€ì‹ê²€ìƒ‰</div>
        <span class="knowledge-badge" id="knowledgeBadge" style="display: none;">0</span>
    </div>

    <!-- 2. ë¯¸ë‹ˆ ì§€ì‹ê²€ìƒ‰ì°½ -->
    <div id="knowledgeMiniWindow" class="knowledge-mini-window" style="display: none;">
        <div class="knowledge-header">
            <h6 class="knowledge-title">ğŸ” ì „ë ¥ê´€ì œ ì§€ì‹ê²€ìƒ‰</h6>
            <div class="knowledge-controls">
                <button id="knowledgeMinimizeBtn" class="btn-knowledge-control" title="ìµœì†Œí™”">
                    <i class="fas fa-minus"></i>
                </button>
                <button id="knowledgeFullscreenBtn" class="btn-knowledge-control" title="ì „ì²´í™”ë©´">
                    <i class="fas fa-expand"></i>
                </button>
                <button id="knowledgeCloseBtn" class="btn-knowledge-control" title="ë‹«ê¸°">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
        <div class="knowledge-body">
            <!-- ê²€ìƒ‰ ì¸í„°í˜ì´ìŠ¤ -->
            <div class="knowledge-search-container">
                <input type="text" id="knowledgeSearchInput" placeholder="ì§ˆë¬¸ í‚¤ì›Œë“œë¥¼ ì…ë ¥í•˜ì„¸ìš” (AND ì¡°ê±´)..."
                    class="knowledge-search-input">
                <button id="knowledgeSearchBtn" class="knowledge-search-btn">
                    <i class="fas fa-search"></i>
                </button>
                <button id="knowledgeAddBtn" class="btn btn-success btn-sm ml-2" title="ìƒˆ ì§€ì‹ ì¶”ê°€">
                    <i class="fas fa-plus"></i> ì¶”ê°€
                </button>
            </div>
            <!-- ê³ ê¸‰ ì˜µì…˜ -->
            <div class="knowledge-advanced-container" style="display: none;">
                <div class="advanced-toggle">
                    <button id="toggleAdvancedBtn" class="btn btn-outline-secondary btn-sm">
                        <i class="fas fa-cog"></i> ê³ ê¸‰ ì˜µì…˜
                    </button>
                </div>
                <div id="advancedOptions" class="advanced-options-panel" style="display: none;">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="enableQualityFilter" checked>
                        <label class="form-check-label" for="enableQualityFilter">
                            â­ í’ˆì§ˆ í•„í„°ë§ (ê³ í’ˆì§ˆ ë‹µë³€ ìš°ì„ )
                        </label>
                    </div>
                </div>
            </div>
            <!-- ê²€ìƒ‰ ì •ë³´ -->
            <div id="knowledgeSearchInfo" class="knowledge-search-info"></div>
            <!-- ê²€ìƒ‰ ê²°ê³¼ -->
            <div id="knowledgeResults" class="knowledge-results">
                <div class="text-center p-4 text-muted">
                    <i class="fas fa-search fa-2x mb-2"></i>
                    <br>í‚¤ì›Œë“œë¥¼ ì…ë ¥í•˜ì—¬ ê²€ìƒ‰í•˜ì„¸ìš”
                </div>
            </div>

            <!-- AI ì¸ì‚¬ì´íŠ¸ ì„¹ì…˜ -->
            <div id="aiBriefingSection" class="ai-briefing-section" style="display: none;">
                <div class="briefing-header">
                    <h6>ğŸ¤– AI ì¸ì‚¬ì´íŠ¸</h6>
                    <div class="briefing-controls">
                        <button id="generateBriefingBtn" class="btn btn-primary btn-sm">
                            <i class="fas fa-brain"></i> ì¸ì‚¬ì´íŠ¸ ìƒì„±
                        </button>
                        <button id="knowledgeChatbotBtn" class="btn btn-success btn-sm">
                            <i class="fas fa-comments"></i> ì±—ë´‡ ì—´ê¸°
                        </button>
                        <button id="closeBriefingBtn" class="btn btn-outline-secondary btn-sm">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
                <div id="briefingContent" class="briefing-content">
                    <div class="briefing-placeholder">
                        <i class="fas fa-lightbulb fa-2x text-muted mb-2"></i>
                        <p class="text-muted">ê²€ìƒ‰ ê²°ê³¼ë¥¼ ì¢…í•©í•œ AI ì¸ì‚¬ì´íŠ¸ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.<br>
                            ê´€ë ¨ í‚¤ì›Œë“œì™€ ë§¥ë½ì„ ë¶„ì„í•˜ì—¬ ìœ ìš©í•œ ì •ë³´ë¥¼ ì œê³µí•©ë‹ˆë‹¤.</p>
                        <small class="text-muted">ìƒì„± ì‹œê°„: ì•½ 3-5ì´ˆ</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 3. ì „ì²´í™”ë©´ ëª¨ë“œ -->
    <div id="knowledgeFullscreen" class="knowledge-fullscreen" style="display: none;">
        <div class="knowledge-fullscreen-header">
            <h4>ğŸ” ì „ë ¥ê´€ì œ ì§€ì‹ ê²€ìƒ‰ ì‹œìŠ¤í…œ</h4>
            <div class="knowledge-controls">
                <button id="knowledgeExitFullscreenBtn" class="btn-knowledge-control" title="ì°½ëª¨ë“œë¡œ ë³µê·€">
                    <i class="fas fa-compress"></i>
                </button>
                <button id="knowledgeFullscreenCloseBtn" class="btn-knowledge-control" title="ë‹«ê¸°">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
        <div class="knowledge-fullscreen-body">
            <div class="container-fluid">
                <div class="row">
                    <div class="col-12">
                        <!-- ê³ ê¸‰ ì˜µì…˜ ì¶”ê°€ -->
                        <div class="knowledge-advanced-container mb-4">
                            <div class="advanced-toggle">
                                <button id="toggleAdvancedBtnFullscreen" class="btn btn-outline-secondary btn-sm">
                                    <i class="fas fa-cog"></i> ê³ ê¸‰ ì˜µì…˜
                                </button>
                            </div>
                            <div id="advancedOptionsFullscreen" class="advanced-options-panel" style="display: none;">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="enableQualityFilterFullscreen"
                                        checked>
                                    <label class="form-check-label" for="enableQualityFilterFullscreen">
                                        â­ í’ˆì§ˆ í•„í„°ë§ (ê³ í’ˆì§ˆ ë‹µë³€ ìš°ì„ )
                                    </label>
                                </div>
                            </div>
                        </div>

                        <div class="search-section mb-4">
                            <div class="input-group input-group-lg">
                                <input type="text" id="knowledgeFullscreenSearchInput"
                                    placeholder="ì§ˆë¬¸ í‚¤ì›Œë“œë¥¼ ì…ë ¥í•˜ì„¸ìš” (ì—¬ëŸ¬ í‚¤ì›Œë“œëŠ” ê³µë°±ìœ¼ë¡œ êµ¬ë¶„, AND ì¡°ê±´)..." class="form-control">
                                <div class="input-group-append">
                                    <button id="knowledgeFullscreenSearchBtn" class="btn btn-primary" type="button">
                                        <i class="fas fa-search"></i> ê²€ìƒ‰
                                    </button>
                                    <button id="knowledgeFullscreenAddBtn" class="btn btn-success" type="button">
                                        <i class="fas fa-plus"></i> ìƒˆ ì§€ì‹ ì¶”ê°€
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div id="knowledgeFullscreenSearchInfo" class="search-info-section"></div>
                        <div id="knowledgeFullscreenResults" class="results-section">
                            <div class="text-center p-5 text-muted">
                                <i class="fas fa-search fa-4x mb-3"></i>
                                <h5>ì „ë ¥ê´€ì œ ì§€ì‹ ê²€ìƒ‰</h5>
                                <p>í‚¤ì›Œë“œë¥¼ ì…ë ¥í•˜ì—¬ ì „ë ¥ê´€ì œ ê´€ë ¨ ì§€ì‹ì„ ê²€ìƒ‰í•˜ì„¸ìš”.<br>
                                    ì—¬ëŸ¬ í‚¤ì›Œë“œ ì…ë ¥ ì‹œ ëª¨ë“  í‚¤ì›Œë“œê°€ í¬í•¨ëœ ê²°ê³¼ë§Œ í‘œì‹œë©ë‹ˆë‹¤.</p>
                            </div>
                        </div>

                        <!-- AI ì¸ì‚¬ì´íŠ¸ ì„¹ì…˜ (ì „ì²´í™”ë©´ ëª¨ë“œ) -->
                        <div id="aiBriefingSectionFullscreen" class="ai-briefing-section" style="display: none;">
                            <div class="briefing-header">
                                <h6>ğŸ¤– AI ì¸ì‚¬ì´íŠ¸ (ì „ì²´í™”ë©´)</h6>
                                <div class="briefing-controls">
                                    <button id="generateBriefingBtnFullscreen" class="btn btn-primary btn-sm">
                                        <i class="fas fa-brain"></i> ì¸ì‚¬ì´íŠ¸ ìƒì„±
                                    </button>
                                    <button id="closeBriefingBtnFullscreen" class="btn btn-outline-secondary btn-sm">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </div>
                            <div id="briefingContentFullscreen" class="briefing-content">
                                <div class="briefing-placeholder">
                                    <i class="fas fa-lightbulb fa-2x text-muted mb-2"></i>
                                    <p class="text-muted">AI ì¸ì‚¬ì´íŠ¸ê°€ ì¤€ë¹„ë˜ë©´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 4. ì§€ì‹ ìƒì„¸ë³´ê¸° ëª¨ë‹¬ (ì½ê¸° ì „ìš©) -->
    <div id="knowledgeDetailModal" class="modal fade" tabindex="-1" aria-labelledby="knowledgeDetailModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="knowledgeDetailModalLabel">ì§€ì‹ ìƒì„¸ë³´ê¸°</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="ë‹«ê¸°"></button>
                </div>
                <div class="modal-body">
                    <div id="knowledgeDetailContent">
                        <!-- ë™ì  ë‚´ìš© -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ë‹«ê¸°</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 5. ì§€ì‹ í¸ì§‘ ëª¨ë‹¬ -->
    <div id="knowledgeEditModal" class="modal fade" tabindex="-1" aria-labelledby="knowledgeEditModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="knowledgeEditModalLabel">ì§€ì‹ í¸ì§‘</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="ë‹«ê¸°"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <!-- í¸ì§‘ í¼ -->
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label for="editQuestion" class="form-label">ì§ˆë¬¸</label>
                                <input type="text" class="form-control" id="editQuestion" placeholder="ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”">
                            </div>
                            <div class="form-group mb-3">
                                <label for="editAnswer" class="form-label">ë‹µë³€</label>
                                <textarea class="form-control" id="editAnswer" rows="8"
                                    placeholder="ë‹µë³€ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea>
                            </div>
                        </div>
                        <!-- ì‹¤ì‹œê°„ ë¯¸ë¦¬ë³´ê¸° -->
                        <div class="col-md-6">
                            <div class="preview-section">
                                <h6>ë¯¸ë¦¬ë³´ê¸°</h6>
                                <div class="preview-content">
                                    <div class="preview-question" id="previewQuestion"></div>
                                    <div class="preview-answer" id="previewAnswer"></div>
                                </div>
                            </div>
                            <!-- ìœ ì‚¬ ì§ˆë¬¸ ê²½ê³  -->
                            <div id="similarWarning" class="alert alert-warning mt-3" style="display: none;">
                                <strong>ìœ ì‚¬í•œ ì§ˆë¬¸ ë°œê²¬:</strong>
                                <ul id="similarList"></ul>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ì·¨ì†Œ</button>
                    <button type="button" class="btn btn-danger" id="deleteKnowledgeBtn"
                        style="display: none;">ì‚­ì œ</button>
                    <button type="button" class="btn btn-primary" id="saveKnowledgeBtn">ì €ì¥</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 6. ì§€ì‹ ì¶”ê°€ ëª¨ë‹¬ -->
    <div id="knowledgeAddModal" class="modal fade" tabindex="-1" aria-labelledby="knowledgeAddModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="knowledgeAddModalLabel">ìƒˆ ì§€ì‹ ì¶”ê°€</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="ë‹«ê¸°"></button>
                </div>
                <div class="modal-body">
                    <div class="form-group mb-3">
                        <label for="newQuestion" class="form-label">ì§ˆë¬¸</label>
                        <input type="text" class="form-control" id="newQuestion" placeholder="ìƒˆ ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”">
                    </div>
                    <div class="form-group mb-3">
                        <label for="newAnswer" class="form-label">ë‹µë³€</label>
                        <textarea class="form-control" id="newAnswer" rows="6" placeholder="ë‹µë³€ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea>
                    </div>
                    <!-- ìœ ì‚¬ ì§ˆë¬¸ ê²½ê³  -->
                    <div id="addSimilarWarning" class="alert alert-warning" style="display: none;">
                        <strong>ìœ ì‚¬í•œ ì§ˆë¬¸ì´ ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤:</strong>
                        <ul id="addSimilarList"></ul>
                        <div class="form-check mt-2">
                            <input class="form-check-input" type="checkbox" id="forceAdd">
                            <label class="form-check-label" for="forceAdd">
                                ê·¸ë˜ë„ ì¶”ê°€í•˜ê¸°
                            </label>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ì·¨ì†Œ</button>
                    <button type="button" class="btn btn-primary" id="addKnowledgeBtn">ì¶”ê°€</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ì§€ì‹ê²€ìƒ‰ CSS ìŠ¤íƒ€ì¼ -->
    <style>
        /* í”Œë¡œíŒ… ë²„íŠ¼ - ë…¸ì•ˆ ì¹œí™”ì  ê°œì„  (2ë°° í¬ê¸°) */
        .knowledge-floating-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 160px;
            /* 80px â†’ 160px (2ë°°) */
            height: 160px;
            /* 80px â†’ 160px (2ë°°) */
            background: linear-gradient(135deg, #28a745 0%, #20c997 50%, #17a2b8 100%);
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            box-shadow:
                0 6px 20px rgba(40, 167, 69, 0.4),
                0 2px 10px rgba(40, 167, 69, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.3);
            z-index: 1000;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            color: white;
            font-size: 52px;
            /* 26px â†’ 52px (2ë°°) */
            border: 6px solid rgba(255, 255, 255, 0.3);
            /* 3px â†’ 6px (2ë°°) */
            backdrop-filter: blur(10px);
        }

        .knowledge-floating-btn:hover {
            transform: scale(1.15) translateY(-2px);
            box-shadow:
                0 12px 35px rgba(40, 167, 69, 0.6),
                0 4px 15px rgba(40, 167, 69, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.4);
            border-color: rgba(255, 255, 255, 0.5);
        }

        .knowledge-floating-btn:active {
            transform: scale(1.05) translateY(0px);
            transition: all 0.1s ease;
        }

        /* í”Œë¡œíŒ… ë²„íŠ¼ ë‚´ë¶€ í…ìŠ¤íŠ¸ (2ë°° í¬ê¸°) */
        .knowledge-floating-btn .btn-icon {
            font-size: 56px;
            /* 28px â†’ 56px (2ë°°) */
            margin-bottom: 4px;
            /* 2px â†’ 4px (2ë°°) */
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .knowledge-floating-btn .btn-text {
            font-size: 22px;
            /* 11px â†’ 22px (2ë°°) */
            font-weight: 600;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
            letter-spacing: 1px;
            /* 0.5px â†’ 1px (2ë°°) */
        }

        .knowledge-badge {
            position: absolute;
            top: -16px;
            /* -8px â†’ -16px (2ë°°) */
            right: -16px;
            /* -8px â†’ -16px (2ë°°) */
            background: linear-gradient(135deg, #dc3545, #c82333);
            color: white;
            border-radius: 30px;
            /* 15px â†’ 30px (2ë°°) */
            padding: 8px 16px;
            /* 4px 8px â†’ 8px 16px (2ë°°) */
            font-size: 28px;
            /* 14px â†’ 28px (2ë°°) */
            font-weight: bold;
            min-width: 48px;
            /* 24px â†’ 48px (2ë°°) */
            height: 48px;
            /* 24px â†’ 48px (2ë°°) */
            text-align: center;
            box-shadow: 0 3px 10px rgba(220, 53, 69, 0.5);
            border: 4px solid white;
            /* 2px â†’ 4px (2ë°°) */
            line-height: 32px;
            /* 16px â†’ 32px (2ë°°) */
        }

        /* í„ìŠ¤ ì• ë‹ˆë©”ì´ì…˜ íš¨ê³¼ (2ë°° í¬ê¸°) */
        .knowledge-floating-btn::before {
            content: '';
            position: absolute;
            top: -6px;
            /* -3px â†’ -6px (2ë°°) */
            left: -6px;
            /* -3px â†’ -6px (2ë°°) */
            right: -6px;
            /* -3px â†’ -6px (2ë°°) */
            bottom: -6px;
            /* -3px â†’ -6px (2ë°°) */
            border-radius: 50%;
            background: linear-gradient(135deg, #28a745, #20c997);
            opacity: 0.6;
            z-index: -1;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
                opacity: 0.6;
            }

            50% {
                transform: scale(1.1);
                opacity: 0.3;
            }

            100% {
                transform: scale(1);
                opacity: 0.6;
            }
        }

        /* ì ‘ê·¼ì„±ì„ ìœ„í•œ í¬ì»¤ìŠ¤ ìŠ¤íƒ€ì¼ */
        .knowledge-floating-btn:focus {
            outline: none;
            box-shadow:
                0 12px 35px rgba(40, 167, 69, 0.6),
                0 4px 15px rgba(40, 167, 69, 0.3),
                0 0 0 8px rgba(40, 167, 69, 0.3);
            /* 4px â†’ 8px (2ë°°) */
        }

        /* ë¯¸ë‹ˆ ê²€ìƒ‰ì°½ */
        .knowledge-mini-window {
            position: fixed;
            bottom: 100px;
            right: 20px;
            width: 420px;
            height: 550px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            z-index: 1001;
            flex-direction: column;
            resize: both;
            overflow: hidden;
            border: 1px solid #ddd;
        }

        .knowledge-header {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            padding: 12px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: 12px 12px 0 0;
            cursor: move;
        }

        .knowledge-title {
            margin: 0;
            font-weight: bold;
        }

        .knowledge-controls {
            display: flex;
            gap: 5px;
        }

        .btn-knowledge-control {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 5px 8px;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .btn-knowledge-control:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .knowledge-body {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }

        .knowledge-search-container {
            padding: 15px;
            border-bottom: 1px solid #eee;
            display: flex;
            gap: 10px;
        }

        .knowledge-search-input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }

        .knowledge-search-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
        }

        .knowledge-search-info {
            padding: 10px 15px;
            background: #f8f9fa;
            border-bottom: 1px solid #eee;
            font-size: 12px;
            color: #666;
        }

        .knowledge-results {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
        }

        /* ì „ì²´í™”ë©´ ëª¨ë“œ */
        .knowledge-fullscreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: white;
            z-index: 1002;
            flex-direction: column;
        }

        .knowledge-fullscreen-header {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            padding: 16px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .knowledge-fullscreen-body {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .search-section {
            max-width: 800px;
            margin: 0 auto;
        }

        .search-info-section {
            max-width: 800px;
            margin: 0 auto 20px;
        }

        .results-section {
            max-width: 800px;
            margin: 0 auto;
        }

        /* ê²€ìƒ‰ ê²°ê³¼ ìŠ¤íƒ€ì¼ */
        .knowledge-result-item {
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            transition: box-shadow 0.2s;
        }

        .knowledge-result-item:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .result-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .result-rank {
            font-size: 12px;
        }

        .result-keywords .badge {
            font-size: 10px;
            margin-right: 3px;
        }

        .result-question {
            margin-bottom: 10px;
        }

        .question-text,
        .answer-preview {
            margin-top: 5px;
            line-height: 1.4;
        }

        .result-answer {
            margin-bottom: 10px;
            color: #666;
        }

        .result-actions {
            text-align: right;
        }

        /* í‚¤ì›Œë“œ í•˜ì´ë¼ì´íŒ… */
        .keyword-highlight {
            background-color: #fff3cd;
            color: #856404;
            padding: 1px 3px;
            border-radius: 3px;
            font-weight: bold;
        }

        /* ë°˜ì‘í˜• ë° ì¶”ê°€ ê°œì„  */
        @media (max-width: 768px) {
            .knowledge-floating-btn {
                width: 70px;
                height: 70px;
                bottom: 20px;
                right: 20px;
                font-size: 24px;
            }

            .knowledge-floating-btn .btn-icon {
                font-size: 24px;
            }

            .knowledge-floating-btn .btn-text {
                font-size: 10px;
            }

            .knowledge-mini-window {
                width: calc(100vw - 40px);
                right: 20px;
                left: 20px;
            }
        }

        @media (max-width: 480px) {
            .knowledge-floating-btn {
                width: 65px;
                height: 65px;
                bottom: 15px;
                right: 15px;
            }

            .knowledge-floating-btn .btn-text {
                font-size: 9px;
            }
        }

        /* ê³ ëŒ€ë¹„ ëª¨ë“œ ì§€ì› */
        @media (prefers-contrast: high) {
            .knowledge-floating-btn {
                border: 4px solid white;
                background: #28a745;
            }

            .knowledge-badge {
                border: 3px solid white;
            }
        }

        /* ì• ë‹ˆë©”ì´ì…˜ ì¤„ì´ê¸° ì„ í˜¸ ì‹œ */
        @media (prefers-reduced-motion: reduce) {
            .knowledge-floating-btn {
                transition: none;
            }

            .knowledge-floating-btn::before {
                animation: none;
            }

            .knowledge-floating-btn:hover {
                transform: scale(1.05);
            }
        }
    </style>

    <!-- ì§€ì‹ í¸ì§‘/ì¶”ê°€/ë¸Œë¦¬í•‘ CSS ìŠ¤íƒ€ì¼ -->
    <style>
        /* ë¯¸ë¦¬ë³´ê¸° ì„¹ì…˜ */
        .preview-section {
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            padding: 1rem;
            background-color: #f8f9fa;
        }

        .preview-content {
            background: white;
            padding: 1rem;
            border-radius: 0.25rem;
            border: 1px solid #e9ecef;
            max-height: 300px;
            overflow-y: auto;
        }

        .preview-question {
            font-weight: bold;
            margin-bottom: 0.5rem;
            color: #495057;
        }

        .preview-answer {
            color: #6c757d;
            line-height: 1.5;
        }

        /* ìœ ì‚¬ ì§ˆë¬¸ ê²½ê³  */
        .similar-list {
            max-height: 150px;
            overflow-y: auto;
        }

        /* AI ì¸ì‚¬ì´íŠ¸ ì„¹ì…˜ */
        .ai-briefing-section {
            margin-top: 20px;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            background: #f8f9fa;
        }

        .briefing-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            border-bottom: 1px solid #e9ecef;
            background: white;
            border-radius: 8px 8px 0 0;
        }

        .briefing-content {
            padding: 20px;
            background: white;
            border-radius: 0 0 8px 8px;
        }

        /* ì§€ì‹ ê²€ìƒ‰ AI ì¸ì‚¬ì´íŠ¸ì—ë§Œ ìŠ¤í¬ë¡¤ ì ìš© */
        #briefingContent,
        #briefingContentFullscreen {
            max-height: 800px;
            overflow-y: auto;
        }

        .briefing-placeholder {
            text-align: center;
            padding: 20px;
        }

        .briefing-loading {
            text-align: center;
            padding: 20px;
        }

        .briefing-result {
            line-height: 1.6;
        }

        .briefing-meta {
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #e9ecef;
        }

        .briefing-text p {
            margin-bottom: 1rem;
        }

        .briefing-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 15px;
        }

        /* ìš©ì–´ ë°°ì§€ */
        .term-badge {
            display: inline-block;
            background: #e9ecef;
            color: #495057;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            margin: 2px;
        }

        .term-badge.highlighted {
            background: #28a745;
            color: white;
        }

        /* í’ˆì§ˆ í‘œì‹œê¸° */
        .quality-indicator {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            font-size: 12px;
        }

        .quality-score.excellent {
            color: #28a745;
        }

        .quality-score.good {
            color: #17a2b8;
        }

        .quality-score.fair {
            color: #ffc107;
        }

        .quality-score.poor {
            color: #dc3545;
        }

        /* ê³ ê¸‰ ì˜µì…˜ */
        .knowledge-advanced-container {
            margin-top: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 6px;
            border: 1px solid #e9ecef;
        }

        .advanced-toggle {
            text-align: center;
            margin-bottom: 10px;
        }

        .advanced-options-panel {
            background: white;
            padding: 15px;
            border-radius: 4px;
            border: 1px solid #dee2e6;
        }

        .advanced-options-panel .form-check {
            margin-bottom: 10px;
        }

        .advanced-options-panel .form-check-label {
            font-size: 14px;
            margin-left: 5px;
        }

        /* í¸ì§‘ ë²„íŠ¼ë“¤ - ìƒì„¸ë³´ê¸° ë²„íŠ¼ ìœ„ì— ì¸ë¼ì¸ìœ¼ë¡œ í‘œì‹œ */
        .edit-actions {
            display: flex !important;
            gap: 8px;
            justify-content: flex-start;
            align-items: center;
            margin-bottom: 8px;
        }

        .result-item:hover .edit-actions {
            opacity: 1;
        }

        /* ì „ì²´í™”ë©´ ê³ ê¸‰ ì˜µì…˜ */
        .knowledge-fullscreen .knowledge-advanced-container {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }

        .knowledge-fullscreen .advanced-options-panel {
            background: white;
            padding: 15px;
            border-radius: 4px;
            border: 1px solid #dee2e6;
            margin-top: 10px;
        }

        /* ëª¨ë°”ì¼ ë°˜ì‘í˜• */
        @media (max-width: 768px) {
            .preview-section {
                margin-top: 1rem;
            }

            .briefing-header {
                flex-direction: column;
                gap: 10px;
                align-items: flex-start;
            }

            .briefing-controls {
                width: 100%;
                justify-content: flex-end;
            }
        }
    </style>

    <!-- ì§€ì‹ê²€ìƒ‰ JavaScript -->
    <script>
        // ì§€ì‹ê²€ìƒ‰ UI í´ë˜ìŠ¤
        class KnowledgeSearchUI {
            constructor() {
                this.isMinimized = true;
                this.isFullscreen = false;
                this.currentPage = 1;
                this.resultsPerPage = 50; // í”Œë¡œíŒ… ì°½ì—ì„œ ë” ë§ì€ ê²°ê³¼ í‘œì‹œ
                this.lastQuery = '';
                this.isSearching = false;

                this.initEventListeners();
                this.initDrag();
            }

            initEventListeners() {
                // í”Œë¡œíŒ… ë²„íŠ¼ í´ë¦­ ë° í‚¤ë³´ë“œ ì ‘ê·¼ì„±
                const floatingBtn = document.getElementById('knowledgeFloatingBtn');

                floatingBtn.addEventListener('click', () => {
                    this.showMiniWindow();
                });

                // í‚¤ë³´ë“œ ì ‘ê·¼ì„± (Enter, Space)
                floatingBtn.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        this.showMiniWindow();
                    }
                });

                // ë¯¸ë‹ˆì°½ ì»¨íŠ¸ë¡¤ ë²„íŠ¼ë“¤
                document.getElementById('knowledgeMinimizeBtn').addEventListener('click', () => {
                    this.showFloating();
                });

                document.getElementById('knowledgeFullscreenBtn').addEventListener('click', () => {
                    this.showFullscreen();
                });

                document.getElementById('knowledgeCloseBtn').addEventListener('click', () => {
                    this.showFloating();
                });

                // ì „ì²´í™”ë©´ ì»¨íŠ¸ë¡¤ ë²„íŠ¼ë“¤
                document.getElementById('knowledgeExitFullscreenBtn').addEventListener('click', () => {
                    this.showMiniWindow();
                });

                document.getElementById('knowledgeFullscreenCloseBtn').addEventListener('click', () => {
                    this.showFloating();
                });

                // ê²€ìƒ‰ ê¸°ëŠ¥
                document.getElementById('knowledgeSearchBtn').addEventListener('click', () => {
                    const query = document.getElementById('knowledgeSearchInput').value;
                    this.performSearch(query);
                });

                document.getElementById('knowledgeFullscreenSearchBtn').addEventListener('click', () => {
                    const query = document.getElementById('knowledgeFullscreenSearchInput').value;
                    this.performSearch(query);
                });

                // ì—”í„°í‚¤ë¡œ ê²€ìƒ‰
                document.getElementById('knowledgeSearchInput').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        this.performSearch(e.target.value);
                    }
                });

                document.getElementById('knowledgeFullscreenSearchInput').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        this.performSearch(e.target.value);
                    }
                });

                // ì‹¤ì‹œê°„ ê²€ìƒ‰ (debounce)
                let searchTimeout;
                const handleRealTimeSearch = (e) => {
                    clearTimeout(searchTimeout);
                    searchTimeout = setTimeout(() => {
                        if (e.target.value.trim().length >= 2) {
                            this.performSearch(e.target.value);
                        }
                    }, 500);
                };

                document.getElementById('knowledgeSearchInput').addEventListener('input', handleRealTimeSearch);
                document.getElementById('knowledgeFullscreenSearchInput').addEventListener('input', handleRealTimeSearch);

                // ê²€ìƒ‰ ê²°ê³¼ì—ì„œ ìƒì„¸ë³´ê¸° ë²„íŠ¼ í´ë¦­ (ì´ë²¤íŠ¸ ìœ„ì„)
                document.getElementById('knowledgeResults').addEventListener('click', (e) => {
                    if (e.target.closest('.detailed-analysis-btn')) {
                        // ê¸°ì¡´ ìƒì„¸ë³´ê¸° ëª¨ë‹¬ ì‚¬ìš©
                        this.showKnowledgeDetail(e.target.closest('.detailed-analysis-btn'));
                    }
                });

                document.getElementById('knowledgeFullscreenResults').addEventListener('click', (e) => {
                    if (e.target.closest('.detailed-analysis-btn')) {
                        this.showKnowledgeDetail(e.target.closest('.detailed-analysis-btn'));
                    }
                });

                // ì¶”ê°€ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
                document.getElementById('knowledgeAddBtn')?.addEventListener('click', () => {
                    if (window.enhancedKnowledgeSystem?.editor) {
                        window.enhancedKnowledgeSystem.editor.showAddModal();
                    }
                });

                document.getElementById('knowledgeFullscreenAddBtn')?.addEventListener('click', () => {
                    if (window.enhancedKnowledgeSystem?.editor) {
                        window.enhancedKnowledgeSystem.editor.showAddModal();
                    }
                });
            }

            initDrag() {
                // ë¯¸ë‹ˆì°½ ë“œë˜ê·¸ ê¸°ëŠ¥
                let isDragging = false;
                let currentX, currentY, initialX, initialY;
                const miniWindow = document.getElementById('knowledgeMiniWindow');
                const header = miniWindow.querySelector('.knowledge-header');

                header.addEventListener('mousedown', (e) => {
                    isDragging = true;
                    initialX = e.clientX - miniWindow.offsetLeft;
                    initialY = e.clientY - miniWindow.offsetTop;
                });

                document.addEventListener('mousemove', (e) => {
                    if (isDragging) {
                        e.preventDefault();
                        currentX = e.clientX - initialX;
                        currentY = e.clientY - initialY;

                        miniWindow.style.left = currentX + 'px';
                        miniWindow.style.top = currentY + 'px';
                        miniWindow.style.right = 'auto';
                        miniWindow.style.bottom = 'auto';
                    }
                });

                document.addEventListener('mouseup', () => {
                    isDragging = false;
                });
            }

            // ìƒíƒœ ì „í™˜ ë©”ì„œë“œë“¤
            showFloating() {
                document.getElementById('knowledgeFloatingBtn').style.display = 'flex';
                document.getElementById('knowledgeMiniWindow').style.display = 'none';
                document.getElementById('knowledgeFullscreen').style.display = 'none';
                this.isMinimized = true;
                this.isFullscreen = false;
            }

            showMiniWindow() {
                document.getElementById('knowledgeFloatingBtn').style.display = 'none';
                document.getElementById('knowledgeMiniWindow').style.display = 'flex';
                document.getElementById('knowledgeFullscreen').style.display = 'none';
                this.isMinimized = false;
                this.isFullscreen = false;

                // ê²€ìƒ‰ì°½ì— í¬ì»¤ìŠ¤
                setTimeout(() => {
                    document.getElementById('knowledgeSearchInput').focus();
                }, 100);
            }

            showFullscreen() {
                document.getElementById('knowledgeFloatingBtn').style.display = 'none';
                document.getElementById('knowledgeMiniWindow').style.display = 'none';
                document.getElementById('knowledgeFullscreen').style.display = 'flex';
                this.isMinimized = false;
                this.isFullscreen = true;

                // ê²€ìƒ‰ì–´ ë™ê¸°í™”
                const miniSearchValue = document.getElementById('knowledgeSearchInput').value;
                document.getElementById('knowledgeFullscreenSearchInput').value = miniSearchValue;

                // ê²€ìƒ‰ì°½ì— í¬ì»¤ìŠ¤
                setTimeout(() => {
                    document.getElementById('knowledgeFullscreenSearchInput').focus();
                }, 100);
            }

            // ê²€ìƒ‰ ê¸°ëŠ¥
            async performSearch(query) {
                if (this.isSearching || !query || query.trim().length === 0) return;

                this.isSearching = true;
                this.lastQuery = query.trim();

                // UI ì—…ë°ì´íŠ¸
                this.updateSearchUI(true);

                try {
                    const response = await fetch('/api/knowledge/search', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            query: query.trim(),
                            page: 1,
                            limit: this.resultsPerPage
                        })
                    });

                    const data = await response.json();

                    if (response.ok && data.success) {
                        this.renderResults(data.data);
                        this.updateSearchInfo(data.data);
                    } else {
                        throw new Error(data.error || 'ê²€ìƒ‰ ì‹¤íŒ¨');
                    }

                } catch (error) {
                    console.error('ê²€ìƒ‰ ì˜¤ë¥˜:', error);
                    this.renderError(error.message);
                } finally {
                    this.isSearching = false;
                    this.updateSearchUI(false);
                }
            }

            updateSearchUI(isSearching) {
                const miniBtn = document.getElementById('knowledgeSearchBtn');
                const fullBtn = document.getElementById('knowledgeFullscreenSearchBtn');

                if (isSearching) {
                    miniBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                    fullBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ê²€ìƒ‰ì¤‘...';
                } else {
                    miniBtn.innerHTML = '<i class="fas fa-search"></i>';
                    fullBtn.innerHTML = '<i class="fas fa-search"></i> ê²€ìƒ‰';
                }
            }

            renderResults(data) {
                const miniContainer = document.getElementById('knowledgeResults');
                const fullscreenContainer = document.getElementById('knowledgeFullscreenResults');
                const { results, total, keywords } = data;

                // ë°°ì§€ ì—…ë°ì´íŠ¸
                const badge = document.getElementById('knowledgeBadge');
                if (total > 0) {
                    badge.textContent = total;
                    badge.style.display = 'block';
                } else {
                    badge.style.display = 'none';
                }

                if (results.length === 0) {
                    const noResultsHTML = `
                        <div class="no-results text-center p-4">
                            <i class="fas fa-search-minus fa-3x text-muted mb-3"></i>
                            <h6>ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</h6>
                            <p class="text-muted">
                                í‚¤ì›Œë“œ <strong>[${keywords.join(', ')}]</strong>ê°€ ëª¨ë‘ í¬í•¨ëœ ì§ˆë¬¸ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.<br>
                                ë‹¤ë¥¸ í‚¤ì›Œë“œë¡œ ê²€ìƒ‰í•´ë³´ì„¸ìš”.
                            </p>
                        </div>`;
                    miniContainer.innerHTML = noResultsHTML;
                    fullscreenContainer.innerHTML = noResultsHTML;
                    this.currentResults = [];
                    return;
                }

                const resultsHTML = results.map((result, index) => `
                    <div class="knowledge-result-item" data-index="${index}">
                        <div class="result-header">
                            <div class="result-rank">
                                <span class="badge badge-primary">${result.rank}</span>
                                <span class="text-muted ml-2">ê´€ë ¨ë„: ${result.relevance_score}ì </span>
                            </div>
                            <div class="result-keywords">
                                ${result.matched_keywords.map(kw =>
                    `<span class="badge badge-success badge-sm">${kw}</span>`
                ).join(' ')}
                            </div>
                        </div>
                        
                        <div class="result-question">
                            <strong class="text-primary">Q:</strong>
                            <div class="question-text">${result.highlighted_question}</div>
                        </div>
                        
                        <div class="result-answer">
                            <strong class="text-success">A:</strong>
                            <div class="answer-preview text-muted">${result.answer_preview}</div>
                        </div>
                        
                        <div class="result-actions">
                            <button class="btn btn-outline-primary btn-sm detailed-analysis-btn"
                                    data-source="knowledge"
                                    data-question="${this.escapeHtml(result.question)}"
                                    data-answer="${this.escapeHtml(result.answer)}">
                                <i class="fas fa-eye"></i> ìƒì„¸ë³´ê¸°
                            </button>
                        </div>
                    </div>
                `).join('');

                miniContainer.innerHTML = resultsHTML;
                fullscreenContainer.innerHTML = resultsHTML;

                // í˜„ì¬ ê²°ê³¼ë¥¼ ì €ì¥í•˜ì—¬ í¸ì§‘ ê¸°ëŠ¥ì—ì„œ ì‚¬ìš©
                this.currentResults = results;

                // ê²€ìƒ‰ ê²°ê³¼ê°€ ìˆìœ¼ë©´ AI ì¸ì‚¬ì´íŠ¸ ì˜µì…˜ í‘œì‹œ (í˜„ì¬ ëª¨ë“œì— ë§ê²Œ)
                if (results && results.length > 0 && window.knowledgeSearchUI && window.knowledgeSearchUI.briefing) {
                    console.log('AI ì¸ì‚¬ì´íŠ¸ ì˜µì…˜ í‘œì‹œ ì‹œë„, isFullscreen:', this.isFullscreen);
                    window.knowledgeSearchUI.briefing.showBriefingOption(results);
                    console.log('AI ì¸ì‚¬ì´íŠ¸ ì˜µì…˜ í‘œì‹œ ì™„ë£Œ');
                } else {
                    console.log('AI ì¸ì‚¬ì´íŠ¸ ì˜µì…˜ í‘œì‹œ ì¡°ê±´ ë¶ˆì¶©ì¡±:', {
                        results: !!results,
                        resultsLength: results?.length,
                        knowledgeSearchUI: !!window.knowledgeSearchUI,
                        briefing: !!window.knowledgeSearchUI?.briefing
                    });
                }
            }

            updateSearchInfo(data) {
                const { total, keywords, searchTime, searchStats } = data;
                const miniInfo = document.getElementById('knowledgeSearchInfo');
                const fullInfo = document.getElementById('knowledgeFullscreenSearchInfo');

                const infoHTML = `
                    <div class="alert alert-info mb-3">
                        <div class="row">
                            <div class="col-md-6">
                                <strong>ê²€ìƒ‰ ê²°ê³¼:</strong> ${total}ê±´<br>
                                <strong>í‚¤ì›Œë“œ:</strong> [${keywords.join(', ')}] (AND ì¡°ê±´)
                            </div>
                            <div class="col-md-6">
                                <strong>ê²€ìƒ‰ ì‹œê°„:</strong> ${searchTime}<br>
                                <strong>ê²€ìƒ‰ ëŒ€ìƒ:</strong> ì§ˆë¬¸(Q) ë°ì´í„°ë§Œ
                            </div>
                        </div>
                        ${searchStats ? `
                        <hr class="my-2">
                        <small class="text-muted">
                            ì²« í‚¤ì›Œë“œ ë§¤ì¹­: ${searchStats.candidatesAfterFirstKeyword}ê±´ â†’ 
                            AND í•„í„°ë§ í›„: ${searchStats.finalResults}ê±´
                        </small>
                        ` : ''}
                    </div>`;

                if (miniInfo) miniInfo.innerHTML = infoHTML;
                if (fullInfo) fullInfo.innerHTML = infoHTML;
            }

            renderError(message) {
                const errorHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle"></i>
                        ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${message}
                    </div>`;

                document.getElementById('knowledgeResults').innerHTML = errorHTML;
                document.getElementById('knowledgeFullscreenResults').innerHTML = errorHTML;
            }

            showKnowledgeDetail(button) {
                const question = button.dataset.question;
                const answer = button.dataset.answer;

                // ê¸°ì¡´ ëª¨ë‹¬ ì‚¬ìš©
                const modal = new bootstrap.Modal(document.getElementById('detailedAnalysisModal'));

                // ëª¨ë‹¬ ì œëª© ë³€ê²½
                document.getElementById('detailedAnalysisModalLabel').textContent = 'ì§€ì‹ ìƒì„¸ë³´ê¸°';

                // ëª¨ë‹¬ ë‚´ìš© ë³€ê²½
                const modalBody = document.querySelector('#detailedAnalysisModal .modal-body');
                modalBody.innerHTML = `
                    <div class="knowledge-detail-container">
                        <div class="card border-success mb-3">
                            <div class="card-header bg-success text-white">
                                <h4 class="mb-0">â“ ì§ˆë¬¸</h4>
                            </div>
                            <div class="card-body">
                                <p class="card-text" style="font-size: 1.2rem; line-height: 1.6;">
                                    ${question}
                                </p>
                            </div>
                        </div>
                        
                        <div class="card border-info">
                            <div class="card-header bg-info text-white">
                                <h4 class="mb-0">ğŸ’¡ ë‹µë³€</h4>
                            </div>
                            <div class="card-body">
                                <div class="answer-content" style="font-size: 1.1rem; line-height: 1.7;">
                                    ${this.formatAnswerText(answer)}
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                modal.show();
            }

            formatAnswerText(text) {
                if (!text) return '';

                return text
                    .replace(/â€¢/g, '<br>â€¢ ')
                    .replace(/â–ª/g, '<br>â–ª ')
                    .replace(/\n/g, '<br>')
                    .replace(/<br><br>/g, '<br>')
                    .trim();
            }

            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text || '';
                return div.innerHTML;
            }

            reloadData() {
                if (this.lastQuery) {
                    console.log('ë°ì´í„° ë¦¬ë¡œë“œ:', this.lastQuery);
                    this.performSearch(this.lastQuery);
                } else {
                    console.log('ë¦¬ë¡œë“œí•  ì¿¼ë¦¬ê°€ ì—†ìŒ');
                }
            }
        }

        // --- ì§€ì‹ í¸ì§‘ ì‹œìŠ¤í…œ ---
        class KnowledgeEditor {
            constructor(searchUI) {
                this.searchUI = searchUI;
                this.currentEditIndex = null;
                this.similarityCheckTimeout = null;

                this.initEvents();
                this.initRealTimePreview();
            }

            initEvents() {
                console.log('KnowledgeEditor initEvents ì‹œì‘');

                // ì¶”ê°€ ë²„íŠ¼ (ëª¨ë‹¬ ë‚´)
                const addBtn = document.getElementById('addKnowledgeBtn');
                console.log('addKnowledgeBtn ì°¾ìŒ:', !!addBtn);
                addBtn?.addEventListener('click', () => {
                    console.log('ëª¨ë‹¬ ë‚´ ì¶”ê°€ ë²„íŠ¼ í´ë¦­');
                    this.addNewItem();
                });

                // ì €ì¥ ë²„íŠ¼
                const saveBtn = document.getElementById('saveKnowledgeBtn');
                console.log('saveKnowledgeBtn ì°¾ìŒ:', !!saveBtn);
                saveBtn?.addEventListener('click', () => {
                    console.log('ì €ì¥ ë²„íŠ¼ í´ë¦­');
                    this.saveEdit();
                });

                // ì‚­ì œ ë²„íŠ¼
                const deleteBtn = document.getElementById('deleteKnowledgeBtn');
                console.log('deleteKnowledgeBtn ì°¾ìŒ:', !!deleteBtn);
                deleteBtn?.addEventListener('click', () => {
                    console.log('ì‚­ì œ ë²„íŠ¼ í´ë¦­');
                    this.deleteItem();
                });

                console.log('KnowledgeEditor initEvents ì™„ë£Œ');
            }

            initRealTimePreview() {
                // ì‹¤ì‹œê°„ ë¯¸ë¦¬ë³´ê¸°
                const editQuestion = document.getElementById('editQuestion');
                const editAnswer = document.getElementById('editAnswer');

                if (editQuestion && editAnswer) {
                    editQuestion.addEventListener('input', () => this.updatePreview());
                    editAnswer.addEventListener('input', () => this.updatePreview());
                }

                // ìƒˆ í•­ëª© ì¶”ê°€ ì‹œ ìœ ì‚¬ ì²´í¬
                const newQuestion = document.getElementById('newQuestion');
                if (newQuestion) {
                    newQuestion.addEventListener('input', (e) => {
                        this.checkSimilarQuestions(e.target.value);
                    });
                }
            }

            showAddModal() {
                // í¼ ì´ˆê¸°í™”
                document.getElementById('newQuestion').value = '';
                document.getElementById('newAnswer').value = '';
                document.getElementById('addSimilarWarning').style.display = 'none';
                document.getElementById('forceAdd').checked = false;

                // ëª¨ë‹¬ í‘œì‹œ
                const modal = new bootstrap.Modal(document.getElementById('knowledgeAddModal'));
                modal.show();
            }

            showEditModal(index) {
                console.log('showEditModal í˜¸ì¶œ, index:', index);
                console.log('this.searchUI.currentResults:', this.searchUI.currentResults);
                console.log('this.searchUI.currentResults length:', this.searchUI.currentResults?.length);

                const item = this.searchUI.currentResults?.[index];
                if (!item) {
                    console.error('í¸ì§‘í•  í•­ëª©ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ, index:', index);
                    return;
                }

                console.log('í¸ì§‘í•  í•­ëª©:', item);
                this.currentEditIndex = index;
                this.currentEditId = item.id;

                // í¼ ì±„ìš°ê¸°
                document.getElementById('editQuestion').value = item.instruction || item.question || '';
                document.getElementById('editAnswer').value = item.output || item.answer || '';
                document.getElementById('deleteKnowledgeBtn').style.display = 'inline-block';

                // ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸
                this.updatePreview();

                // ìœ ì‚¬ ì§ˆë¬¸ ì²´í¬
                this.checkSimilarQuestions(item.instruction || item.question, index);

                // ëª¨ë‹¬ í‘œì‹œ
                const modal = new bootstrap.Modal(document.getElementById('knowledgeEditModal'));
                modal.show();
            }

            updatePreview() {
                const question = document.getElementById('editQuestion').value;
                const answer = document.getElementById('editAnswer').value;

                document.getElementById('previewQuestion').innerHTML = this.formatText(question);
                document.getElementById('previewAnswer').innerHTML = this.formatText(answer);
            }

            formatText(text) {
                return text
                    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                    .replace(/\*(.*?)\*/g, '<em>$1</em>')
                    .replace(/\n/g, '<br>');
            }

            async checkSimilarQuestions(question, excludeIndex = null) {
                clearTimeout(this.similarityCheckTimeout);
                this.similarityCheckTimeout = setTimeout(async () => {
                    if (question.length < 3) {
                        document.getElementById('similarWarning').style.display = 'none';
                        document.getElementById('addSimilarWarning').style.display = 'none';
                        return;
                    }

                    try {
                        const response = await fetch('/api/knowledge/check-similar', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ question, excludeId: excludeIndex })
                        });

                        const result = await response.json();
                        this.showSimilarWarning(result.similar);

                    } catch (error) {
                        console.error('ìœ ì‚¬ë„ ì²´í¬ ì‹¤íŒ¨:', error);
                    }
                }, 500);
            }

            showSimilarWarning(similar) {
                const editWarning = document.getElementById('similarWarning');
                const addWarning = document.getElementById('addSimilarWarning');
                const editList = document.getElementById('similarList');
                const addList = document.getElementById('addSimilarList');

                if (similar && similar.length > 0) {
                    const listHTML = similar.map(s =>
                        `<li>${s.question} (${Math.round(s.similarity * 100)}% ìœ ì‚¬)</li>`
                    ).join('');

                    if (editList) {
                        editList.innerHTML = listHTML;
                        editWarning.style.display = 'block';
                    }

                    if (addList) {
                        addList.innerHTML = listHTML;
                        addWarning.style.display = 'block';
                    }
                } else {
                    if (editWarning) editWarning.style.display = 'none';
                    if (addWarning) addWarning.style.display = 'none';
                }
            }

            async saveEdit() {
                const question = document.getElementById('editQuestion').value.trim();
                const answer = document.getElementById('editAnswer').value.trim();

                if (!question || !answer) {
                    alert('ì§ˆë¬¸ê³¼ ë‹µë³€ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                    return;
                }

                try {
                    const response = await fetch(`/api/knowledge/edit/${this.currentEditId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ question, answer })
                    });

                    const result = await response.json();

                    if (result.success) {
                        alert('ì§€ì‹ì´ ì„±ê³µì ìœ¼ë¡œ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
                        // ëª¨ë‹¬ ë‹«ê¸° (Bootstrap 4 í˜¸í™˜)
                        const modalElement = document.getElementById('knowledgeEditModal');
                        const modal = new bootstrap.Modal(modalElement);
                        modal.hide();
                        this.searchUI.reloadData(); // ê²€ìƒ‰ ê²°ê³¼ ë¦¬ë¡œë“œ
                    } else {
                        alert('ìˆ˜ì • ì‹¤íŒ¨: ' + result.error);
                    }

                } catch (error) {
                    console.error('ìˆ˜ì • ì˜¤ë¥˜:', error);
                    alert('ìˆ˜ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                }
            }

            async deleteItem() {
                console.log('deleteItem í˜¸ì¶œ, currentEditIndex:', this.currentEditIndex, 'currentEditId:', this.currentEditId);

                if (!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) {
                    return;
                }

                try {
                    console.log('ì‚­ì œ API í˜¸ì¶œ ì‹œì‘');
                    const response = await fetch(`/api/knowledge/delete/${this.currentEditId}`, {
                        method: 'DELETE'
                    });

                    console.log('ì‚­ì œ API ì‘ë‹µ:', response.status);
                    const result = await response.json();
                    console.log('ì‚­ì œ API ê²°ê³¼:', result);

                    if (result.success) {
                        alert('ì§€ì‹ì´ ì„±ê³µì ìœ¼ë¡œ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');

                        // ëª¨ë‹¬ ë‹«ê¸° (Bootstrap 4 í˜¸í™˜)
                        const modalElement = document.getElementById('knowledgeEditModal');
                        const modal = new bootstrap.Modal(modalElement);
                        modal.hide();

                        // ê²€ìƒ‰ ê²°ê³¼ ë¦¬ë¡œë“œ
                        if (this.searchUI.reloadData) {
                            this.searchUI.reloadData();
                        } else {
                            console.warn('reloadData ë©”ì„œë“œê°€ ì—†ìŒ, ìˆ˜ë™ ë¦¬ë¡œë“œ í•„ìš”');
                        }
                    } else {
                        alert('ì‚­ì œ ì‹¤íŒ¨: ' + result.error);
                    }
                } catch (error) {
                    console.error('ì‚­ì œ ì˜¤ë¥˜:', error);
                    alert('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
                }
            }

            async addNewItem() {
                const question = document.getElementById('newQuestion').value.trim();
                const answer = document.getElementById('newAnswer').value.trim();
                const force = document.getElementById('forceAdd').checked;

                if (!question || !answer) {
                    alert('ì§ˆë¬¸ê³¼ ë‹µë³€ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                    return;
                }

                try {
                    const response = await fetch('/api/knowledge/add', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ question, answer, force })
                    });

                    const result = await response.json();

                    if (result.success) {
                        alert('ì§€ì‹ì´ ì„±ê³µì ìœ¼ë¡œ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.');
                        // ëª¨ë‹¬ ë‹«ê¸° (Bootstrap 4 í˜¸í™˜)
                        const modalElement = document.getElementById('knowledgeAddModal');
                        const modal = new bootstrap.Modal(modalElement);
                        modal.hide();
                        this.searchUI.reloadData(); // ê²€ìƒ‰ ê²°ê³¼ ë¦¬ë¡œë“œ
                    } else {
                        if (result.code === 'SIMILAR_EXISTS') {
                            this.showSimilarWarning(result.similar);
                            alert('ìœ ì‚¬í•œ ì§ˆë¬¸ì´ ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤. í™•ì¸ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                        } else {
                            alert('ì¶”ê°€ ì‹¤íŒ¨: ' + result.error);
                        }
                    }

                } catch (error) {
                    console.error('ì¶”ê°€ ì˜¤ë¥˜:', error);
                    alert('ì¶”ê°€ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                }
            }
        }

        // --- AI ì¸ì‚¬ì´íŠ¸ ì‹œìŠ¤í…œ ---
        class KnowledgeBriefing {
            constructor(searchUI, isFullscreen = false) {
                this.searchUI = searchUI;
                this.isFullscreen = isFullscreen;
                this.isGenerating = false;
                this.currentBriefing = null;

                this.initEvents();
            }

            initEvents() {
                // ì¼ë°˜ ëª¨ë“œ ë²„íŠ¼ë“¤
                const generateBtn = document.getElementById('generateBriefingBtn');
                const closeBtn = document.getElementById('closeBriefingBtn');

                if (generateBtn) {
                    generateBtn.addEventListener('click', () => {
                        this.isFullscreen = false; // ì¼ë°˜ ëª¨ë“œ
                        this.generateBriefing(false);
                    }); // ìˆ˜ë™ ì‹œì‘
                }

                if (closeBtn) {
                    closeBtn.addEventListener('click', () => this.hideBriefing());
                }

                // ì „ì²´í™”ë©´ ëª¨ë“œ ë²„íŠ¼ë“¤ (ì´ˆê¸°í™” ì‹œ ì¡´ì¬í•˜ëŠ” ê²½ìš°)
                const generateBtnFullscreen = document.getElementById('generateBriefingBtnFullscreen');
                const closeBtnFullscreen = document.getElementById('closeBriefingBtnFullscreen');

                if (generateBtnFullscreen) {
                    generateBtnFullscreen.addEventListener('click', () => {
                        this.isFullscreen = true; // ì „ì²´í™”ë©´ ëª¨ë“œ
                        this.generateBriefing(false);
                    }); // ìˆ˜ë™ ì‹œì‘
                }

                if (closeBtnFullscreen) {
                    closeBtnFullscreen.addEventListener('click', () => this.hideBriefing());
                }
            }

            showBriefingOption(results = null) {
                // í˜„ì¬ ëª¨ë“œ í™•ì¸ (ì „ì²´í™”ë©´ ëª¨ë“œì¸ì§€)
                const isFullscreenMode = document.getElementById('knowledgeFullscreen').style.display === 'flex';
                this.isFullscreen = isFullscreenMode;

                const sectionId = this.isFullscreen ? 'aiBriefingSectionFullscreen' : 'aiBriefingSection';
                const section = document.getElementById(sectionId);
                if (section) {
                    section.style.display = 'block';

                    // ë¶€ë“œëŸ¬ìš´ í‘œì‹œ
                    section.style.opacity = '0';
                    section.style.transform = 'translateY(-10px)';

                    setTimeout(() => {
                        section.style.transition = 'all 0.3s ease';
                        section.style.opacity = '1';
                        section.style.transform = 'translateY(0)';
                    }, 50);
                }
            }

            hideBriefing() {
                const sectionId = this.isFullscreen ? 'aiBriefingSectionFullscreen' : 'aiBriefingSection';
                const section = document.getElementById(sectionId);
                if (section) {
                    section.style.display = 'none';
                }
            }

            async generateBriefing(autoStart = false) {
                console.log('generateBriefing() í˜¸ì¶œë¨, autoStart:', autoStart);
                if (this.isGenerating) {
                    console.log('ì´ë¯¸ ìƒì„± ì¤‘ì´ë¯€ë¡œ ì¤‘ë‹¨');
                    return;
                }

                const btnId = this.isFullscreen ? 'generateBriefingBtnFullscreen' : 'generateBriefingBtn';
                const contentId = this.isFullscreen ? 'briefingContentFullscreen' : 'briefingContent';
                const btn = document.getElementById(btnId);
                const content = document.getElementById(contentId);

                // ìƒíƒœ ë³€ê²½
                this.isGenerating = true;

                // ìˆ˜ë™ ìƒì„± ì‹œì—ë§Œ ë¡œë”© ìƒíƒœ ì„¤ì • (ìë™ ìƒì„±ì‹œëŠ” ì´ë¯¸ ì„¤ì •ë¨)
                if (!autoStart) {
                    if (btn) {
                        btn.disabled = true;
                        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ìƒì„± ì¤‘...';
                    }

                    if (content) {
                        content.innerHTML = `
                            <div class="briefing-loading text-center p-4">
                                <div class="spinner-border text-primary mb-3" role="status" style="width: 3rem; height: 3rem;">
                                    <span class="sr-only">ìƒì„± ì¤‘...</span>
                                </div>
                                <h5 class="text-primary mb-2">ğŸ¤– AI ì¸ì‚¬ì´íŠ¸ ìƒì„± ì¤‘</h5>
                                <p class="text-muted">ê²€ìƒ‰ ê²°ê³¼ë¥¼ ë¶„ì„í•˜ì—¬ ì¸ì‚¬ì´íŠ¸ë¥¼ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤...</p>
                                <div class="progress mt-3" style="height: 6px;">
                                    <div class="progress-bar progress-bar-striped progress-bar-animated bg-primary" 
                                         role="progressbar" style="width: 100%"></div>
                                </div>
                            </div>
                        `;
                    }
                }

                try {
                    // 3ë¶„ íƒ€ì„ì•„ì›ƒ ì„¤ì •
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 180000); // 3ë¶„

                    const response = await fetch('/api/knowledge/generate-briefing', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            query: this.searchUI.lastQuery,
                            searchResults: this.searchUI.currentResults || []
                        }),
                        signal: controller.signal
                    });

                    clearTimeout(timeoutId);
                    const result = await response.json();

                    if (result.success) {
                        this.displayBriefing(result);
                        this.currentBriefing = result;
                    } else {
                        throw new Error(result.error || 'ì¸ì‚¬ì´íŠ¸ ìƒì„± ì‹¤íŒ¨');
                    }

                } catch (error) {
                    console.error('ì¸ì‚¬ì´íŠ¸ ìƒì„± ì˜¤ë¥˜:', error);

                    // íƒ€ì„ì•„ì›ƒ ì—ëŸ¬ ì²˜ë¦¬
                    if (error.name === 'AbortError') {
                        this.showBriefingError('ì‘ë‹µ ì‹œê°„ì´ ì´ˆê³¼ë˜ì—ˆìŠµë‹ˆë‹¤ (3ë¶„). ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                    } else {
                        this.showBriefingError(error.message);
                    }
                } finally {
                    // ë²„íŠ¼ ë³µì›
                    this.isGenerating = false;
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fas fa-brain"></i> ì¸ì‚¬ì´íŠ¸ ìƒì„±';
                }
            }

            displayBriefing(result) {
                const contentId = this.isFullscreen ? 'briefingContentFullscreen' : 'briefingContent';
                const content = document.getElementById(contentId);
                const briefing = result.briefing || '';
                const metadata = result.metadata || {};

                content.innerHTML = `
                    <div class="briefing-result">
                        <div class="briefing-meta">
                            <small class="text-muted">
                                <i class="fas fa-clock"></i> ${new Date().toLocaleTimeString()} ìƒì„±
                                ${metadata.termsAnalyzed ? ` â€¢ ${metadata.termsAnalyzed}ê°œ ìš©ì–´ ë¶„ì„` : ''}
                                ${metadata.sourcesUsed ? ` â€¢ ${metadata.sourcesUsed}ê°œ ì¶œì²˜ ì¢…í•©` : ''}
                            </small>
                        </div>
                        <div class="briefing-text">
                            ${this.formatBriefingText(briefing)}
                        </div>
                        <div class="briefing-actions">
                            <button class="btn btn-outline-primary btn-sm" onclick="navigator.clipboard.writeText('${briefing.replace(/'/g, "\\'")}')">
                                <i class="fas fa-copy"></i> ë³µì‚¬
                            </button>
                            <button class="btn btn-outline-secondary btn-sm" onclick="window.print()">
                                <i class="fas fa-print"></i> ì¸ì‡„
                            </button>
                        </div>
                    </div>
                `;
            }

            formatBriefingText(text) {
                return text
                    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                    .replace(/\*(.*?)\*/g, '<em>$1</em>')
                    .replace(/\n\n/g, '</p><p>')
                    .replace(/\n/g, '<br>')
                    .replace(/^/, '<p>')
                    .replace(/$/, '</p>');
            }

            showBriefingError(message) {
                const contentId = this.isFullscreen ? 'briefingContentFullscreen' : 'briefingContent';
                const content = document.getElementById(contentId);
                content.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle"></i>
                        ì¸ì‚¬ì´íŠ¸ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ${message}
                        <br><small>ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.</small>
                    </div>
                `;
            }

            showBriefingPanel() {
                console.log('showBriefingPanel() í˜¸ì¶œë¨, isFullscreen:', this.isFullscreen);
                const sectionId = this.isFullscreen ? 'aiBriefingSectionFullscreen' : 'aiBriefingSection';
                const section = document.getElementById(sectionId);
                console.log('section ID:', sectionId, 'ì°¾ìŒ:', !!section);
                if (section) {
                    section.style.display = 'block';
                    // ë¶€ë“œëŸ¬ìš´ í‘œì‹œ ì• ë‹ˆë©”ì´ì…˜
                    section.style.opacity = '0';
                    section.style.transform = 'translateY(-10px)';
                    setTimeout(() => {
                        section.style.transition = 'all 0.3s ease';
                        section.style.opacity = '1';
                        section.style.transform = 'translateY(0)';
                        console.log('showBriefingPanel ì• ë‹ˆë©”ì´ì…˜ ì ìš©ë¨');

                        // í‘œì‹œëœ ì„¹ì…˜ìœ¼ë¡œ ìŠ¤í¬ë¡¤
                        setTimeout(() => {
                            section.scrollIntoView({
                                behavior: 'smooth',
                                block: 'nearest',
                                inline: 'nearest'
                            });
                        }, 300);
                    }, 10);
                } else {
                    console.error('aiBriefingSection ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ');
                }
            }

            setLoadingState(message = 'AI ì¸ì‚¬ì´íŠ¸ë¥¼ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤...') {
                console.log('setLoadingState() í˜¸ì¶œë¨, ë©”ì‹œì§€:', message, 'isFullscreen:', this.isFullscreen);
                const contentId = this.isFullscreen ? 'briefingContentFullscreen' : 'briefingContent';
                const btnId = this.isFullscreen ? 'generateBriefingBtnFullscreen' : 'generateBriefingBtn';
                const content = document.getElementById(contentId);
                const btn = document.getElementById(btnId);
                console.log('content ID:', contentId, 'ì°¾ìŒ:', !!content);
                console.log('btn ID:', btnId, 'ì°¾ìŒ:', !!btn);
                console.log('generateBriefingBtn ì°¾ìŒ:', !!btn);

                if (content) {
                    content.innerHTML = `
                        <div class="briefing-loading text-center p-4">
                            <div class="spinner-border text-primary mb-3" role="status" style="width: 3rem; height: 3rem;">
                                <span class="sr-only">ìƒì„± ì¤‘...</span>
                            </div>
                            <h5 class="text-primary mb-2">ğŸ¤– AI ì¸ì‚¬ì´íŠ¸ ìƒì„± ì¤‘</h5>
                            <p class="text-muted">${message}</p>
                            <div class="progress mt-3" style="height: 6px;">
                                <div class="progress-bar progress-bar-striped progress-bar-animated bg-primary" 
                                     role="progressbar" style="width: 100%"></div>
                            </div>
                        </div>
                    `;
                }

                if (btn) {
                    btn.disabled = true;
                    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ìƒì„± ì¤‘...';
                }
            }
        }

        // --- í†µí•© ì§€ì‹ ê´€ë¦¬ ì‹œìŠ¤í…œ ---
        class EnhancedKnowledgeSystem {
            constructor() {
                this.searchUI = null;
                this.editor = null;
                this.briefing = null;

                this.init();
            }

            init() {
                console.log('EnhancedKnowledgeSystem init ì‹œì‘');
                // DOMì´ ì´ë¯¸ ë¡œë“œë˜ì—ˆëŠ”ì§€ í™•ì¸
                if (document.readyState === 'loading') {
                    // ì•„ì§ ë¡œë“œ ì¤‘ì´ë©´ ì´ë²¤íŠ¸ ëŒ€ê¸°
                    document.addEventListener('DOMContentLoaded', () => {
                        this.initializeSystem();
                    });
                } else {
                    // ì´ë¯¸ ë¡œë“œë˜ì—ˆìœ¼ë©´ ë°”ë¡œ ì´ˆê¸°í™”
                    this.initializeSystem();
                }
            }

            initializeSystem() {
                console.log('DOMContentLoaded ì´ë²¤íŠ¸ ë°œìƒ');
                console.log('window.knowledgeSearchUI ì¡´ì¬:', !!window.knowledgeSearchUI);
                if (window.knowledgeSearchUI) {
                    this.searchUI = window.knowledgeSearchUI;
                    console.log('KnowledgeEditor ì´ˆê¸°í™” ì‹œì‘');
                    this.editor = new KnowledgeEditor(this.searchUI);
                    console.log('KnowledgeEditor ì´ˆê¸°í™” ì™„ë£Œ:', !!this.editor);
                    console.log('showEditModal ë©”ì„œë“œ ì¡´ì¬:', typeof this.editor?.showEditModal);

                    console.log('KnowledgeBriefing ì´ˆê¸°í™” ì‹œì‘');
                    this.briefing = new KnowledgeBriefing(this.searchUI);
                    console.log('KnowledgeBriefing ì´ˆê¸°í™” ì™„ë£Œ:', !!this.briefing);

                    // ê²€ìƒ‰ ê²°ê³¼ì— í¸ì§‘ ë²„íŠ¼ ì¶”ê°€
                    console.log('í¸ì§‘ ë²„íŠ¼ ì¶”ê°€ ì‹œì‘ - ê²°ê³¼ ìˆ˜:', this.searchUI?.currentResults?.length || 0);
                    this.enhanceSearchResults();

                    // ê³ ê¸‰ ì˜µì…˜ ì´ˆê¸°í™”
                    this.initAdvancedOptions();

                    console.log('ì§€ì‹ í¸ì§‘ ì‹œìŠ¤í…œì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.');
                } else {
                    console.error('KnowledgeSearchUIê°€ ì´ˆê¸°í™”ë˜ì§€ ì•ŠìŒ');
                }
            }

            initAdvancedOptions() {
                // ë¯¸ë‹ˆ ì°½ ê³ ê¸‰ ì˜µì…˜
                const miniToggleBtn = document.getElementById('toggleAdvancedBtn');
                const miniOptionsPanel = document.getElementById('advancedOptions');

                if (miniToggleBtn && miniOptionsPanel) {
                    miniToggleBtn.addEventListener('click', () => {
                        const isVisible = miniOptionsPanel.style.display !== 'none';
                        miniOptionsPanel.style.display = isVisible ? 'none' : 'block';
                        miniToggleBtn.innerHTML = isVisible ?
                            '<i class="fas fa-cog"></i> ê³ ê¸‰ ì˜µì…˜' :
                            '<i class="fas fa-cog"></i> ê³ ê¸‰ ì˜µì…˜ ë‹«ê¸°';
                    });
                }

                // ì „ì²´í™”ë©´ ê³ ê¸‰ ì˜µì…˜ (ìƒˆë¡œ ì¶”ê°€)
                const fullToggleBtn = document.getElementById('toggleAdvancedBtnFullscreen');
                const fullOptionsPanel = document.getElementById('advancedOptionsFullscreen');

                if (fullToggleBtn && fullOptionsPanel) {
                    fullToggleBtn.addEventListener('click', () => {
                        const isVisible = fullOptionsPanel.style.display !== 'none';
                        fullOptionsPanel.style.display = isVisible ? 'none' : 'block';
                        fullToggleBtn.innerHTML = isVisible ?
                            '<i class="fas fa-cog"></i> ê³ ê¸‰ ì˜µì…˜' :
                            '<i class="fas fa-cog"></i> ê³ ê¸‰ ì˜µì…˜ ë‹«ê¸°';
                    });
                }

                // ê¸°ë³¸ì ìœ¼ë¡œ ê³ ê¸‰ ì˜µì…˜ í‘œì‹œ
                const miniContainer = document.querySelector('.knowledge-advanced-container');
                const fullContainer = document.querySelector('.knowledge-fullscreen .knowledge-advanced-container');

                if (miniContainer) miniContainer.style.display = 'block';
                if (fullContainer) fullContainer.style.display = 'block';
            }

            enhanceSearchResults() {
                console.log('enhanceSearchResults í•¨ìˆ˜ ì‹¤í–‰ë¨');

                // ê²€ìƒ‰ ì™„ë£Œ í›„ ì½œë°± ì¶”ê°€
                const originalPerformSearch = this.searchUI.performSearch.bind(this.searchUI);
                this.searchUI.performSearch = async (query) => {
                    console.log('ê²€ìƒ‰ ì‹œì‘:', query);
                    await originalPerformSearch(query);
                    console.log('ê²€ìƒ‰ ì™„ë£Œ, ê²°ê³¼ ìˆ˜:', this.searchUI.currentResults?.length || 0);

                    // ê²€ìƒ‰ ê²°ê³¼ê°€ ìˆìœ¼ë©´ AI ì¸ì‚¬ì´íŠ¸ ì˜µì…˜ í‘œì‹œ
                    if (this.searchUI.currentResults && this.searchUI.currentResults.length > 0) {
                        console.log('AI ì¸ì‚¬ì´íŠ¸ ì˜µì…˜ í‘œì‹œ');
                        this.briefing.showBriefingOption(this.searchUI.currentResults);
                    }

                    // ê²€ìƒ‰ ê²°ê³¼ì— í¸ì§‘ ë²„íŠ¼ ì¶”ê°€
                    setTimeout(() => {
                        this.addEditButtonsToResults();
                    }, 100);
                };

                // ì´ë²¤íŠ¸ ìœ„ì„ìœ¼ë¡œ í¸ì§‘/ì‚­ì œ ì²˜ë¦¬
                const handleResultClick = (e) => {
                    const resultItem = e.target.closest('.knowledge-result-item, .result-item');
                    if (!resultItem) {
                        console.log('ê²°ê³¼ í•­ëª©ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ');
                        return;
                    }

                    const index = parseInt(resultItem.dataset.index);
                    console.log('ê²°ê³¼ í•­ëª© í´ë¦­:', index, 'íƒ€ê²Ÿ:', e.target.className);

                    if (e.target.closest('.edit-btn')) {
                        e.preventDefault();
                        console.log('í¸ì§‘ ë²„íŠ¼ í´ë¦­:', index);
                        console.log('this.editor ì¡´ì¬:', !!this.editor);
                        console.log('this.editor.showEditModal ì¡´ì¬:', typeof this.editor?.showEditModal);

                        if (this.editor && this.editor.showEditModal) {
                            try {
                                this.editor.showEditModal(index);
                                console.log('í¸ì§‘ ëª¨ë‹¬ í‘œì‹œ ì„±ê³µ');
                            } catch (error) {
                                console.error('í¸ì§‘ ëª¨ë‹¬ í‘œì‹œ ì‹¤íŒ¨:', error);
                            }
                        } else {
                            console.error('í¸ì§‘ ì—ë””í„°ê°€ ì´ˆê¸°í™”ë˜ì§€ ì•ŠìŒ');
                        }
                    } else if (e.target.closest('.delete-btn')) {
                        e.preventDefault();
                        console.log('ì‚­ì œ ë²„íŠ¼ í´ë¦­:', index);

                        // ì‚­ì œí•  í•­ëª©ì˜ ID ê°€ì ¸ì˜¤ê¸°
                        const item = this.searchUI.currentResults?.[index];
                        if (!item) {
                            console.error('ì‚­ì œí•  í•­ëª©ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ, index:', index);
                            return;
                        }

                        console.log('this.editor ì¡´ì¬:', !!this.editor);

                        if (this.editor) {
                            this.editor.currentEditId = item.id;
                            console.log('currentEditId ì„¤ì •ë¨:', this.editor.currentEditId);

                            try {
                                this.editor.deleteItem();
                                console.log('ì‚­ì œ í•¨ìˆ˜ í˜¸ì¶œ ì„±ê³µ');
                            } catch (error) {
                                console.error('ì‚­ì œ í•¨ìˆ˜ í˜¸ì¶œ ì‹¤íŒ¨:', error);
                            }
                        } else {
                            console.error('í¸ì§‘ ì—ë””í„°ê°€ ì´ˆê¸°í™”ë˜ì§€ ì•ŠìŒ');
                        }
                    }
                };

                document.getElementById('knowledgeResults')?.addEventListener('click', handleResultClick);
                document.getElementById('knowledgeFullscreenResults')?.addEventListener('click', handleResultClick);
            }

            addEditButtonsToResults() {
                console.log('addEditButtonsToResults ì‹¤í–‰ë¨');
                const resultItems = document.querySelectorAll('.knowledge-result-item, .result-item');
                console.log('ì°¾ì€ ê²°ê³¼ í•­ëª© ìˆ˜:', resultItems.length);

                resultItems.forEach((item, index) => {
                    console.log(`í•­ëª© ${index} ì²˜ë¦¬ ì¤‘:`, item);

                    // ì´ë¯¸ ë²„íŠ¼ì´ ìˆëŠ”ì§€ í™•ì¸
                    const existingActions = item.querySelector('.edit-actions');
                    if (existingActions) {
                        console.log(`í•­ëª© ${index}: ë²„íŠ¼ ì´ë¯¸ ì¡´ì¬`);
                        return;
                    }

                    const actionsContainer = item.querySelector('.result-actions');
                    console.log(`í•­ëª© ${index}ì˜ actionsContainer:`, actionsContainer);

                    if (actionsContainer) {
                        const actions = document.createElement('div');
                        actions.className = 'edit-actions mb-2';
                        actions.style.cssText = `
                            display: flex;
                            gap: 8px;
                            justify-content: flex-start;
                            align-items: center;
                        `;
                        actions.innerHTML = `
                            <button class="btn btn-sm btn-outline-primary edit-btn" title="í¸ì§‘">
                                <i class="fas fa-edit"></i> í¸ì§‘
                            </button>
                            <button class="btn btn-sm btn-outline-danger delete-btn" title="ì‚­ì œ">
                                <i class="fas fa-trash"></i> ì‚­ì œ
                            </button>
                        `;

                        // ìƒì„¸ë³´ê¸° ë²„íŠ¼ ì•ì— ì‚½ì…
                        actionsContainer.insertBefore(actions, actionsContainer.firstChild);

                        console.log(`í•­ëª© ${index}ì— ë²„íŠ¼ ì¶”ê°€ë¨`);
                    } else {
                        console.warn(`í•­ëª© ${index}ì— .result-actionsë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ`);
                        console.log('í•­ëª© HTML:', item.innerHTML.substring(0, 200));
                    }
                });
            }
        }

        // ì‹œìŠ¤í…œ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', () => {
            window.knowledgeSearchUI = new KnowledgeSearchUI();
            window.enhancedKnowledgeSystem = new EnhancedKnowledgeSystem();
        });

        // ==========================================
        // ì±—ë´‡ ê¸°ëŠ¥
        // ==========================================

        // ë„¤ë¹„ê²Œì´ì…˜ ë°” ì±—ë´‡ ë²„íŠ¼ - ìƒˆ íƒ­ìœ¼ë¡œ ì±—ë´‡ ì—´ê¸°
        document.getElementById('navChatbotBtn').addEventListener('click', function () {
            window.open('http://localhost:5000', '_blank');
        });

        // ê²€ìƒ‰ ì‹¤í–‰
        document.getElementById('executeSearchBtn').addEventListener('click', async function () {
            const query = document.getElementById('knowledgeSearchInput').value.trim();

            if (!query) {
                alert('ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
                return;
            }

            try {
                const response = await fetch('/api/knowledge/search', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ query, page: 1, limit: 50 })
                });

                const data = await response.json();

                if (data.success && data.data.results) {
                    currentSearchResults = data.data.results;
                    renderSearchResults(currentSearchResults);
                    document.getElementById('searchResultsContainer').style.display = 'block';
                    document.getElementById('totalResultsCount').textContent = currentSearchResults.length;
                    document.getElementById('briefingResultContainer').style.display = 'none';
                } else {
                    alert('ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.');
                }
            } catch (error) {
                console.error('ê²€ìƒ‰ ì˜¤ë¥˜:', error);
                alert('ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        });

        // Enter í‚¤ë¡œ ê²€ìƒ‰
        document.getElementById('knowledgeSearchInput').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
                document.getElementById('executeSearchBtn').click();
            }
        });

        // ê²€ìƒ‰ ê²°ê³¼ ë Œë”ë§
        function renderSearchResults(results) {
            const tbody = document.getElementById('searchResultsTableBody');
            tbody.innerHTML = '';

            results.forEach((result, index) => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>
                        <input type="checkbox" class="result-checkbox" data-id="${result.id}">
                    </td>
                    <td>${result.rank || index + 1}</td>
                    <td>${result.highlighted_question || result.question}</td>
                    <td>${result.highlighted_answer_preview || result.answer_preview}</td>
                    <td>
                        <span class="badge badge-primary">${(result.relevance_score || 0).toFixed(1)}</span>
                    </td>
                `;
            });

            // ì²´í¬ë°•ìŠ¤ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
            document.querySelectorAll('.result-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', updateSelectedResults);
            });

            // ì„ íƒ ì´ˆê¸°í™”
            selectedResultIds.clear();
            updateSelectedResults();
        }

        // ì„ íƒ ê²°ê³¼ ì—…ë°ì´íŠ¸
        function updateSelectedResults() {
            selectedResultIds.clear();

            document.querySelectorAll('.result-checkbox:checked').forEach(checkbox => {
                selectedResultIds.add(parseInt(checkbox.dataset.id));
            });

            document.getElementById('selectedResultsCount').textContent = selectedResultIds.size;
            document.getElementById('generateBriefingBtn').disabled = selectedResultIds.size === 0;
        }

        // ì „ì²´ ì„ íƒ
        document.getElementById('selectAllBtn').addEventListener('click', function () {
            document.querySelectorAll('.result-checkbox').forEach(checkbox => {
                checkbox.checked = true;
            });
            document.getElementById('selectAllCheckbox').checked = true;
            updateSelectedResults();
        });

        // ì„ íƒ í•´ì œ
        document.getElementById('deselectAllBtn').addEventListener('click', function () {
            document.querySelectorAll('.result-checkbox').forEach(checkbox => {
                checkbox.checked = false;
            });
            document.getElementById('selectAllCheckbox').checked = false;
            updateSelectedResults();
        });

        // í—¤ë” ì²´í¬ë°•ìŠ¤ë¡œ ì „ì²´ ì„ íƒ/í•´ì œ
        document.getElementById('selectAllCheckbox').addEventListener('change', function () {
            const isChecked = this.checked;
            document.querySelectorAll('.result-checkbox').forEach(checkbox => {
                checkbox.checked = isChecked;
            });
            updateSelectedResults();
        });

        // LLM ì¢…í•© ìƒì„±
        document.getElementById('generateBriefingBtn').addEventListener('click', async function () {
            if (selectedResultIds.size === 0) {
                alert('ì¢…í•©í•  í•­ëª©ì„ ì„ íƒí•˜ì„¸ìš”.');
                return;
            }

            const selectedResults = currentSearchResults.filter(r => selectedResultIds.has(r.id));
            const query = document.getElementById('knowledgeSearchInput').value.trim();

            const briefingText = document.getElementById('briefingResultText');
            briefingText.innerHTML = '<i class="fas fa-spinner fa-spin"></i> AIê°€ ì„ íƒëœ ë‚´ìš©ì„ ì¢…í•©í•˜ëŠ” ì¤‘...';
            document.getElementById('briefingResultContainer').style.display = 'block';

            try {
                const response = await fetch('/api/knowledge/generate-briefing', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        query,
                        searchResults: selectedResults,
                        selectedIds: Array.from(selectedResultIds)
                    })
                });

                const data = await response.json();

                if (data.success) {
                    briefingText.textContent = data.briefing || 'ì¢…í•© ê²°ê³¼ë¥¼ ìƒì„±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
                } else {
                    briefingText.textContent = 'ì˜¤ë¥˜: ' + (data.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜');
                }
            } catch (error) {
                console.error('LLM ì¢…í•© ì˜¤ë¥˜:', error);
                briefingText.textContent = 'ì¢…í•© ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message;
            }
        });
        // ì±—ë´‡ ì—´ê¸° í•¨ìˆ˜
        async function openChatbot() {
            try {
                const statusResponse = await fetch('/api/chatbot/status');
                const statusData = await statusResponse.json();

                if (statusData.available) {
                    document.getElementById('chatbotIframe').src = 'http://localhost:5000';
                    $('#chatbotModal').modal('show');
                    document.getElementById('chatbotStatus').innerHTML =
                        '<i class="fas fa-circle text-success"></i> ì±—ë´‡ ì„œë²„ ì—°ê²°ë¨';
                } else {
                    alert('ì±—ë´‡ ì„œë²„ê°€ ì‹¤í–‰ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.\n\nrun_all.batì„ ì‹¤í–‰í•˜ì—¬ ëª¨ë“  ì„œë¹„ìŠ¤ë¥¼ ì‹œì‘í•˜ê±°ë‚˜,\nì±—ë´‡ í´ë”ì˜ "ì±—ë´‡ì‹¤í–‰.bat"ì„ ë³„ë„ë¡œ ì‹¤í–‰í•´ì£¼ì„¸ìš”.');
                }
            } catch (error) {
                console.error('ì±—ë´‡ ìƒíƒœ í™•ì¸ ì˜¤ë¥˜:', error);
                alert('ì±—ë´‡ ì„œë²„ ìƒíƒœë¥¼ í™•ì¸í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            }
        }
        // ì±—ë´‡ ì—´ê¸° ë²„íŠ¼ë“¤
        const openChatbotBtn = document.getElementById('openChatbotBtn');
        const knowledgeChatbotBtn = document.getElementById('knowledgeChatbotBtn');

        if (openChatbotBtn) {
            openChatbotBtn.addEventListener('click', openChatbot);
        }
        if (knowledgeChatbotBtn) {
            knowledgeChatbotBtn.addEventListener('click', openChatbot);
        }


        // ì±—ë´‡ ëª¨ë‹¬ì´ ë‹«í ë•Œ iframe ì´ˆê¸°í™”
        $('#chatbotModal').on('hidden.bs.modal', function () {
            document.getElementById('chatbotIframe').src = '';
        });
    </script>
</body>

</html>